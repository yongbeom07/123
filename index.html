<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>실내 길 안내 로봇</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#f3f4f6;
      --text:#0f172a;
      --subtle:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-2:#22c55e;
      --ring:#60a5fa;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0)}
    body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"맑은 고딕",sans-serif}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:12px 16px;display:flex;align-items:center;gap:8px;background:#ffffffcc;border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border);justify-content:center;color:var(--subtle)}
    header .title{font-size:18px;font-weight:700}
    .spacer{flex:1}

    .btn{border:1px solid var(--border);border-radius:14px;padding:12px 16px;font-weight:700;background:var(--muted);color:var(--text);min-height:44px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--accent-2);color:#052e14}
    .btn.ghost{background:#fff}
    .btn.tab{background:#fff;border-radius:12px;min-height:40px}
    .btn.tab.active{outline:2px solid var(--ring);border-color:transparent}

    .page{display:none;padding:16px;max-width:980px;margin:0 auto}
    .page.active{display:block}

    .hero{text-align:center;padding:28px 16px 10px}
    .hero h1{font-size:30px;margin:10px 0 8px}

    .grid{display:grid;gap:10px}
    .grid.rooms{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:380px){.grid.rooms{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:540px){.grid.rooms{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:900px){.grid.rooms{grid-template-columns:repeat(5,1fr)}}

    .room{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;gap:4px}
    .room .num{font-weight:800;font-size:17px}
    .room .label{font-size:14px;color:#111827;overflow-wrap:anywhere;word-break:break-word;white-space:normal;text-align:center}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--muted);color:#111827;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}

    .searchBox{flex:1;display:flex;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .searchBox input{flex:1;border:0;outline:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
    .modal-backdrop.show{display:flex}
    .modal{background:#fff;padding:16px;border-radius:16px;width:min(92vw,420px)}

    /* 안내중 페이지 */
    .guide-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .guide-status{font-size:14px;color:var(--subtle)}
    .map-wrap{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    #mapCanvas{width:100%;height:360px;display:block;border-radius:12px;background:#fafafa;border:1px dashed var(--border)}
    .guide-controls{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .legend{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:6px;font-size:13px;color:#374151}
    .legend .i{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.cur{background:#111827}
    .dot.goal{background:#2563eb}
    .line-swatch{width:18px;height:3px;background:#22c55e;border-radius:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="btn ghost" id="backBtn" onclick="goBack()">←</button>
      <div class="title">실내 길 안내 로봇</div>
      <div class="spacer"></div>
      <button class="btn" onclick="goHome()">홈</button>
    </header>

    <!-- 홈 -->
    <main id="page-home" class="page active">
      <div class="hero">
        <h1>실내 길 안내 서비스</h1>
        <p>QR 접속 → 층/호실 선택 → 로봇 안내</p>
        <button class="btn primary" onclick="startGuide()">안내 시작하기</button>
      </div>
    </main>

    <!-- 층/호실 선택 -->
    <section id="page-floor" class="page">
      <div class="toolbar">
        <span id="floorTag" class="pill">1층</span>
        <div class="tabbar">
          <button id="tab-1" class="btn tab active" onclick="openFloor(1)">1층</button>
          <button id="tab-2" class="btn tab" onclick="openFloor(2)">2층</button>
          <button id="tab-3" class="btn tab" onclick="openFloor(3)">3층</button>
        </div>
        <div class="searchBox">
          <input id="searchInput" type="text" placeholder="호실 번호/이름 검색" oninput="filterRooms()" />
          <button class="btn" onclick="clearSearch()">지우기</button>
        </div>
      </div>
      <div class="card"><div id="roomList" class="grid rooms"></div></div>
    </section>

    <!-- 안내중 화면 -->
    <section id="page-guide" class="page">
      <div class="guide-header">
        <span class="pill">안내중</span>
        <div class="guide-status" id="guideStatus">연결 대기중…</div>
        <div class="spacer"></div>
      </div>

      <div class="card" style="text-align:center">
        <div><strong>현재 위치:</strong> <span id="curPosText">-</span> &nbsp;|&nbsp; <strong>목적지:</strong> <span id="goalText">-</span></div>
      </div>

      <div class="map-wrap">
        <canvas id="mapCanvas"></canvas>
        <div class="legend">
          <span class="i"><span class="dot cur"></span>현재 위치</span>
          <span class="i"><span class="dot goal"></span>목적지</span>
          <span class="i"><span class="line-swatch"></span>경로</span>
        </div>
      </div>

      <div class="guide-controls">
        <button id="pauseBtn" class="btn" onclick="togglePause()">정지</button>
        <button id="stopBtn" class="btn" onclick="stopGuide()">안내 종료</button>
      </div>
    </section>

    <footer><div>© 2025 Indoor Guide Robot</div></footer>
  </div>

  <!-- 확인 모달 -->
  <div id="confirmWrap" class="modal-backdrop">
    <div class="modal">
      <h3>안내를 시작할까요?</h3>
      <p id="confirmMsg"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="closeConfirm()">아니요</button>
        <button id="confirmYes" class="btn success" onclick="confirmNavigate()">예</button>
      </div>
    </div>
  </div>

  <script>
    /***** 환경 변수 *****/
    const BACKEND_URL = "https://phases-eternal-katrina-eva.trycloudflare.com";
    const API_KEY = "demo-token-123";

    /***** 데이터(호실/라벨) *****/
    const ROOM_INFO={
      1:{"101":"정보통신대학 학장실","102":"전자공학과 학과사무실","102-1":"스마트ICT융합공학과 학과사무실","103":"연구용실험실","106":"해동학술정보실","110":"강의실","113":"강의실","114":"극한반도체 회로/소자 특성분석실","115":"강의실","116":"강의실","117":"강의실","119":"강의실","122":"연구용실험실","123":"강의실","124":"멘토링실","125":"공동동아리방","126":"안전공학과 학생회실","128":"전자공학과 학생회실","129":"정보통신대학 행정실","131":"외래교수실","132":"정보통신대학 학생센터","133":"연구용실험실","136":"연구용실험실","137":"연구용실험실"},
      2:{"201":"전자공학과회의실","201-1":"전자공학과 교수휴게실","202":"신일훈 교수연구실","203":"이병한 교수연구실","204":"박형철 교수연구실","205":"권민우 교수연구실","206":"남재원 교수연구실","207":"실습준비실","208":"아날로그전자실험실습실","209":"마이크로프로세서연구실","210":"프로젝트실습실","211":"인공지능연구실","212":"NX연구실","212-1":"운영체제연구실","213":"반도체소자연구실","214":"회로설계연구실","215":"무선통신연구실","216":"종합설계실","217":"전자기수치해석연구실","218":"전자시뮬레이션실습실","219":"컴퓨터구조연구실","220":"컴퓨터구조연구실","221":"지능제어연구실","222":"컴퓨터실","223":"신호처리연구실","224":"최승호 교수연구실","225":"박민기 교수연구실","226":"도현락 교수연구실","227":"경연웅 교수연구실","228":"양성준 교수연구실","229":"이승은 교수연구실","230":"정태호 교수연구실","231":"이예훈 교수연구실","233":"유비쿼터스컴퓨팅연구실","233-1":"아날로그집적회로설계연구실","234":"유비쿼터스컴퓨팅연구실","235":"종합설계제작실"},
      3:{"301":"김성권 교수연구실","302":"최현덕 교수연구실","304":"황병철 교수연구실","305":"이원영 교수연구실","306":"최의민 교수연구실","307":"김화정 교수연구실","308":"영상처리실험실","309-1":"연구용실험실","309-2":"연구용실험실","310":"교수회의실","311":"멀티미디어회로시스템실험실","312":"ICT회로계측실험실","313":"스마트미디어네트워크실험실","314":"스마트ICT융합공학과 학생회실","315":"기자재실","316":"협동적시스템소프트웨어연구실","317":"멀티미디어실험실","318":"전기전자회로실험실","319":"음향공학실","320":"ICT융합실험실","321":"머신러닝실험실","322":"실감미디어연구실","323":"미디어시뮬레이션실험실","324":"강의실","325":"강의실","326":"강의실","327":"서범준 교수연구실","328":"차병준 교수연구실","329":"이계민 교수연구실","330":"박구만 교수연구실","331":"허성연 교수연구실","332":"정현민 교수연구실","333":"박규태 교수연구실","334":"김동호 교수연구실","334-1":"호수에 오브레곤 교수연구실","335":"전력전자시스템실험실","335-1":"전력전자시스템실험실","336":"로봇지능 및 제어 연구실","337":"집적회로설계실험실","341":"ICT융합공학교육실","342":"ICT공학실험실습실"}
    };
    const RANGES={1:[101,137],2:[201,235],3:[301,342]};

    /***** 상태 *****/
    let currentFloor=1,pendingTarget=null;
    let guiding=false, paused=false, pollingTimer=null, activeRoom=null;
    let lastStatus=null;

    /***** 네비게이션 - 페이지 전환 *****/
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function goHome(){
      stopPolling();
      guiding=false; paused=false; activeRoom=null;
      setActiveTab(1); showPage('page-home');
    }
    function goBack(){
      if(document.getElementById('page-guide').classList.contains('active')){ showPage('page-floor'); return;}
      if(document.getElementById('page-floor').classList.contains('active')) goHome(); else history.back();
    }
    function startGuide(){ openFloor(1); showPage('page-floor'); }
    function setActiveTab(f){ [1,2,3].forEach(x=>{ const el=document.getElementById(`tab-${x}`); if(el) el.classList.toggle('active',x===f); }); }

    /***** 방 카드 구성 *****/
    function addRoomCard(code,label){
      const c=document.createElement('div'); c.className='room'; c.onclick=()=>openConfirm(code,label);
      const num=document.createElement('div'); num.className='num'; num.textContent=`${code}호`; c.appendChild(num);
      if(label){ const lab=document.createElement('div'); lab.className='label'; lab.textContent=label; c.appendChild(lab); }
      document.getElementById('roomList').appendChild(c);
    }
    function buildRoomsForFloor(f){
      const box=document.getElementById('roomList'); box.innerHTML='';
      const [s,e]=RANGES[f];
      for(let n=s;n<=e;n++){
        const code=String(n);
        if(ROOM_INFO[f][code]) addRoomCard(code,ROOM_INFO[f][code]);
        Object.keys(ROOM_INFO[f]).filter(k=>k.startsWith(code+"-")).forEach(hc=>addRoomCard(hc,ROOM_INFO[f][hc]));
      }
    }
    function filterRooms(){
      const q=document.getElementById('searchInput').value.trim().toLowerCase();
      const box=document.getElementById('roomList'); box.innerHTML='';
      if(!q){ buildRoomsForFloor(currentFloor); return; }
      Object.entries(ROOM_INFO).forEach(([f,rooms])=>{
        Object.entries(rooms).forEach(([code,label])=>{
          if(code.toLowerCase().includes(q) || (label&&label.toLowerCase().includes(q))) addRoomCard(code,label);
        });
      });
    }
    function clearSearch(){ document.getElementById('searchInput').value=''; filterRooms(); }
    function openFloor(f){ currentFloor=f; setActiveTab(f); document.getElementById('floorTag').textContent=`${f}층`; buildRoomsForFloor(f); }

    /***** 확인 모달 *****/
    function openConfirm(code,label){
      pendingTarget={code,label};
      document.getElementById('confirmMsg').textContent=`${code}호 ${label?label:''} 로 안내할까요?`;
      document.getElementById('confirmWrap').classList.add('show');
    }
    function closeConfirm(){ document.getElementById('confirmWrap').classList.remove('show'); pendingTarget=null; }

    /***** 백엔드 연동 유틸 *****/
    async function api(path, method="GET", body=null){
      const opt={ method, headers: { 'x-api-key': API_KEY } };
      if(body){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
      const r=await fetch(`${BACKEND_URL}${path}`, opt);
      if(!r.ok) throw new Error(`${method} ${path} failed`);
      const ct=r.headers.get('content-type')||'';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    /***** 안내 시작 *****/
    async function confirmNavigate(){
      if(!pendingTarget) return;
      const target=pendingTarget; closeConfirm();
      try{
        await api('/api/navigate','POST',{ room: target.code });
        activeRoom=target.code; guiding=true; paused=false;
        document.getElementById('goalText').textContent=`${target.code}호 ${target.label?`(${target.label})`:''}`;
        document.getElementById('guideStatus').textContent='안내 시작됨';
        document.getElementById('pauseBtn').textContent='정지';
        showPage('page-guide');
        startPolling();
        alert(`${target.code}호 안내를 시작합니다.`);
      }catch(e){
        alert('안내 시작 실패: 서버 연결을 확인하세요.');
        console.error(e);
      }
    }

    /***** 일시정지/재개 & 종료 *****/
    async function togglePause(){
      if(!guiding) return;
      try{
        if(!paused){ await api('/api/pause','POST'); paused=true; document.getElementById('pauseBtn').textContent='안내 재개'; document.getElementById('guideStatus').textContent='일시 정지됨'; }
        else{ await api('/api/resume','POST'); paused=false; document.getElementById('pauseBtn').textContent='정지'; document.getElementById('guideStatus').textContent='안내 재개됨'; }
      }catch(e){ alert('동작 실패'); console.error(e); }
    }
    async function stopGuide(){
      try{
        await api('/api/stop','POST');
      }catch(e){ /* 선택사항: stop 미구현 시 무시 */ }
      guiding=false; paused=false; activeRoom=null;
      stopPolling(); showPage('page-floor');
    }

    /***** 상태 폴링 *****/
    function startPolling(){
      stopPolling();
      // 초당 1회 폴링(필요 시 조정)
      pollingTimer=setInterval(fetchStatus, 1000);
      fetchStatus(); // 즉시 1회
    }
    function stopPolling(){ if(pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; } }
    async function fetchStatus(){
      try{
        const status=await api('/api/status','GET');
        lastStatus=status;
        updateGuideUI(status);
        if(status && status.arrived){
          stopPolling();
          openArrivedWindow();
        }
      }catch(e){
        document.getElementById('guideStatus').textContent='연결 대기중…';
        // 네트워크 실패 시에도 지도는 마지막 상태를 유지
      }
    }

    /***** 도착 창 *****/
    function openArrivedWindow(){
      const html=`
<!doctype html><html lang="ko"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>안내 완료</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"맑은 고딕",sans-serif;margin:0;background:#fff;color:#111}
  .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
  .card{max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:24px;text-align:center;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  h1{margin:0 0 8px}
  .msg{color:#374151}
  .btn{margin-top:16px;padding:12px 18px;border-radius:12px;border:1px solid #e5e7eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
</style></head>
<body><div class="wrap"><div class="card">
  <h1>목적지에 도착하였습니다</h1>
  <div class="msg">이용해 주셔서 감사합니다.</div>
  <button class="btn" id="returnBtn">로봇 복귀</button>
</div></div>
<script>
  const BACKEND="${BACKEND_URL}";
  const API_KEY="${API_KEY}";
  async function api(path, method="GET", body=null){
    const opt={method,headers:{'x-api-key':API_KEY}};
    if(body){opt.headers['Content-Type']='application/json';opt.body=JSON.stringify(body);}
    const r=await fetch(BACKEND+path,opt);
    if(!r.ok) throw new Error('failed');
    return true;
  }
  document.getElementById('returnBtn').onclick=async ()=>{
    try{ await api('/api/return','POST'); alert('복귀를 시작합니다.'); window.close(); }
    catch(e){ alert('복귀 요청 실패'); }
  };
</script>
</body></html>`;
      const win=window.open("", "_blank");
      win.document.open(); win.document.write(html); win.document.close();
    }

    /***** 지도(캔버스) 그리기 *****/
    const mapEl=(()=>{ const c=document.getElementById('mapCanvas');
      function resize(){ const rect=c.getBoundingClientRect(); c.width=Math.floor(rect.width*devicePixelRatio); c.height=Math.floor(rect.height*devicePixelRatio); }
      const ro=new ResizeObserver(()=>{ resize(); drawMap(lastStatus); }); ro.observe(c);
      resize(); return c; })();

    function updateGuideUI(status){
      // 텍스트 상태 표기
      if(status?.current){ document.getElementById('curPosText').textContent = fmtXY(status.current); }
      if(status?.goal){ document.getElementById('goalText').textContent = `${activeRoom?activeRoom+'호 ':''}${status.goal?'' : ''}`; }
      document.getElementById('guideStatus').textContent = paused ? '일시 정지됨' : '안내중';
      // 지도 갱신
      drawMap(status);
    }

    function drawMap(status){
      const c=mapEl, ctx=c.getContext('2d');
      // 배경
      ctx.save();
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.clearRect(0,0,c.width, c.height);
      ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,c.width/devicePixelRatio,c.height/devicePixelRatio);

      // 데이터 없으면 안내
      if(!status || (!status.path && !status.current && !status.goal)){
        ctx.fillStyle='#9ca3af';
        ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.textAlign='center';
        ctx.fillText('연결 대기중… (경로/좌표 수신 시 자동 표시)', (c.width/devicePixelRatio)/2, (c.height/devicePixelRatio)/2);
        ctx.restore(); return;
      }

      // 좌표 목록 수집
      const pts=[];
      if(Array.isArray(status.path)) status.path.forEach(p=>Array.isArray(p)&&p.length===2&&pts.push(p));
      if(Array.isArray(status.current)) pts.push(status.current);
      if(Array.isArray(status.goal)) pts.push(status.goal);

      // 스케일링 범위 계산
      let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
      pts.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
      if(!isFinite(minX)){ minX=0;minY=0;maxX=10;maxY=10; } // fallback

      const pad=24; // px padding
      const W=c.width/devicePixelRatio, H=c.height/devicePixelRatio;
      const sx=(W-2*pad)/Math.max(1e-6,(maxX-minX));
      const sy=(H-2*pad)/Math.max(1e-6,(maxY-minY));
      const s=Math.min(sx,sy); // 등비 스케일

      function toPix([x,y]){
        const X = pad + (x-minX)*s;
        // y축 위가 +가 되도록 반전 (지도 위쪽이 +Y라고 가정하면 필요 시 변경)
        const Y = H - pad - (y-minY)*s;
        return [X,Y];
      }

      // 경로
      if(Array.isArray(status.path) && status.path.length>=2){
        ctx.lineWidth=3; ctx.strokeStyle='#22c55e';
        ctx.beginPath();
        status.path.forEach((p,i)=>{ const [X,Y]=toPix(p); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
        ctx.stroke();
      }

      // 목적지
      if(Array.isArray(status.goal)){
        const [gx,gy]=toPix(status.goal);
        ctx.fillStyle='#2563eb';
        ctx.beginPath(); ctx.arc(gx,gy,6,0,Math.PI*2); ctx.fill();
      }

      // 현재 위치
      if(Array.isArray(status.current)){
        const [cx,cy]=toPix(status.current);
        ctx.fillStyle='#111827';
        ctx.beginPath(); ctx.arc(cx,cy,6,0,Math.PI*2); ctx.fill();
      }

      ctx.restore();
    }

    function fmtXY(p){ if(!Array.isArray(p)) return '-'; const [x=0,y=0]=p; return `${x.toFixed(2)}, ${y.toFixed(2)}`; }

    /***** 초기 진입 *****/
    document.addEventListener('DOMContentLoaded',()=>showPage('page-home'));
  </script>
</body>
</html>
