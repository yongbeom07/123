<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>실내 길안내 서비스</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#f3f4f6; --text:#0f172a; --subtle:#6b7280;
      --border:#e5e7eb; --accent:#2563eb; --accent-2:#22c55e; --ring:#60a5fa;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0)}
    body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"맑은 고딕",sans-serif}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

    footer{padding:12px 16px;display:flex;align-items:center;gap:8px;background:#ffffffcc;border-top:1px solid var(--border);justify-content:center;color:var(--subtle)}

    header{
      padding:12px 16px;
      background:#ffffffcc;
      border-bottom:1px solid var(--border);
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:8px;
    }
    header .title{
      grid-column:2;
      justify-self:center;
      font-size:18px;
      font-weight:700;
    }
    .spacer{ display:none; }
    .home-active #backBtn, .home-active #homeBtn { display:none; }

    .btn{border:1px solid var(--border);border-radius:14px;padding:12px 16px;font-weight:700;background:var(--muted);color:var(--text);min-height:44px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--accent-2);color:#052e14}
    .btn.ghost{background:#fff}
    .btn.tab{background:#fff;border-radius:12px;min-height:40px}
    .btn.tab.active{outline:2px solid var(--ring);border-color:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .page{display:none;padding:16px;max-width:980px;margin:0 auto}
    .page.active{display:block}

    /* 홈 */
    #page-home .hero{
      min-height:calc(100dvh - 120px);
      display:grid;
      place-items:center;
      text-align:center;
      gap:8px;
    }
    #page-home .hero h1{font-size:30px;margin:0 0 8px}
    #page-home .hero .sub{color:#374151}
    #page-home .btn-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:min(520px,92vw);
      margin-top:12px;
    }
    #btnTogether{padding:18px 20px;font-size:18px;border-radius:16px}
    #btnSummon{padding:18px 20px;font-size:18px;border-radius:16px;background:#fff}

    .grid{display:grid;gap:10px}
    .grid.rooms{grid-template-columns:repeat(3,minmax(0, 1fr))}
    @media (max-width:380px){.grid.rooms{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:540px){.grid.rooms{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:900px){.grid.rooms{grid-template-columns:repeat(5,1fr)}}

    .room{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;gap:4px}
    .room .num{font-weight:800;font-size:17px}
    .room .label{font-size:14px;color:#111827;overflow-wrap:anywhere;word-break:break-word;white-space:normal;text-align:center}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--muted);color:#111827;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}

    .searchBox{flex:1;display:flex;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .searchBox input{flex:1;border:0;outline:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999; pointer-events: none;}
    .modal-backdrop.show{display:flex; pointer-events: auto;}
    .modal{background:#fff;padding:16px;border-radius:16px;width:min(92vw,420px)}

    /* 안내중 */
    .guide-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .guide-status{font-size:14px;color:var(--subtle)}
    .map-wrap{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    #mapCanvas{width:100%;height:360px;display:block;border-radius:12px;background:#fafafa;border:1px dashed var(--border)}
    .guide-controls{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .legend{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:6px;font-size:13px;color:#374151}
    .legend .i{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.cur{background:#111827}
    .dot.goal{background:#2563eb}
    .line-swatch{width:18px;height:3px;background:#22c55e;border-radius:2px}

    /* 소환 페이지 */
    #page-summon .center{
      min-height:calc(100dvh - 160px);
      display:grid;
      place-items:center;
      text-align:center;
      gap:8px;
    }
    #page-summon h2{margin:0}
    #page-summon .hint{color:#374151}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button id="backBtn" class="btn ghost">←</button>
      <div class="title">실내 길안내 서비스</div>
      <div class="spacer"></div>
      <button id="homeBtn" class="btn">홈</button>
    </header>

    <!-- 홈 -->
    <main id="page-home" class="page active">
      <div class="hero">
        <div>
          <h1>어디로 안내할까요?</h1>
          <div class="sub">자리에 로봇이 근처에 있다면 함께 출발해요</div>
          <div class="sub">멀리 있다면 로봇이 먼저 찾아갈게요</div>
        </div>
        <div class="btn-row">
          <button id="btnTogether" class="btn primary">로봇과 함께 있어요</button>
          <button id="btnSummon" class="btn">로봇이 보이지 않아요</button>
        </div>
      </div>
    </main>

    <!-- 소환(복귀/재합류) 진행 화면 -->
    <section id="page-summon" class="page">
      <div class="center">
        <div class="pill" id="summonPill">소환중</div>
        <h2 id="summonTitle">로봇이 열심히 가고 있어요…</h2>
        <div class="hint" id="summonStatus">연결 대기중…</div>
        <div class="hint" id="summonHint">로봇이 도착하면 목적지를 선택할 수 있어요.</div>
      </div>
    </section>

    <!-- 층/호실 선택 -->
    <section id="page-floor" class="page">
      <div class="toolbar">
        <span id="floorTag" class="pill">1층</span>
        <div class="tabbar">
          <button id="tab-1" class="btn tab active">1층</button>
          <button id="tab-2" class="btn tab">2층</button>
          <button id="tab-3" class="btn tab">3층</button>
        </div>
        <div class="searchBox">
          <input id="searchInput" type="text" placeholder="호실 번호/이름 검색" />
          <button id="clearSearchBtn" class="btn">지우기</button>
        </div>
      </div>
      <div class="card"><div id="roomList" class="grid rooms"></div></div>
    </section>

    <!-- 안내중 화면 -->
    <section id="page-guide" class="page">
      <div class="guide-header">
        <span class="pill">안내중</span>
        <div class="guide-status" id="guideStatus">연결 대기중…</div>
        <div class="spacer"></div>
      </div>

      <div class="card" style="text-align:center">
        <div><strong>현재 위치:</strong> <span id="curPosText">-</span> &nbsp;|&nbsp;
             <strong>목적지:</strong> <span id="goalText">-</span></div>
      </div>

      <div class="map-wrap">
        <canvas id="mapCanvas"></canvas>
        <div class="legend">
          <span class="i"><span class="dot cur"></span>현재 위치</span>
          <span class="i"><span class="dot goal"></span>목적지</span>
          <span class="i"><span class="line-swatch"></span>경로</span>
        </div>
      </div>

      <div class="guide-controls">
        <button id="pauseBtn" class="btn">정지</button>
        <button id="stopBtn" class="btn">목적지 변경</button>
        <!-- ▼ 신규: 로봇이 보이지 않을 때 -->
        <button id="lostBtn" class="btn">로봇이 보이지 않아요</button>
      </div>
    </section>

    <footer><div>© 2025 Indoor Guide Robot</div></footer>
  </div>

  <!-- 안내 시작 확인 모달 -->
  <div id="confirmWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">안내를 시작할까요?</h3>
      <p id="confirmMsg"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="confirmNo" class="btn">아니요</button>
        <button id="confirmYes" class="btn success">예</button>
      </div>
    </div>
  </div>

    <!-- ◆ 도착 모달 -->
  <div id="arrivedWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="arrivedTitle">
      <h3 id="arrivedTitle">목적지에 도착하였습니다</h3>
      <p id="arrivedDesc" style="color:#475569">이용해 주셔서 감사합니다.</p>
      <div id="arrivedDest" class="pill" style="margin:8px 0;display:inline-block"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="arrivedReturn" class="btn success">로봇 복귀</button>
        <button id="arrivedClose" class="btn">닫기</button>
      </div>
    </div>
  </div>

  <!-- ▼ 로봇이 보이지 않을 때 입력 모달 -->
  <div id="lostWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lostTitle">
      <h3 id="lostTitle">지금 옆의 호실을 입력해 주세요</h3>
      <p style="color:#475569;margin-top:4px">예: 101, 215 등. 로봇이 해당 호실 앞으로 이동해 합류합니다.</p>
      <div class="searchBox" style="margin-top:8px">
        <input id="lostInput" type="text" inputmode="numeric" pattern="[0-9\\-]*" placeholder="호실 번호 (숫자만)" />
        <button id="lostClear" class="btn">지우기</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="lostCancel" class="btn">취소</button>
        <button id="lostGo" class="btn success">이 위치로 오기</button>
      </div>
    </div>
  </div>

  <!-- ▼ 재안내 시작 확인 모달 -->
  <div id="rejoinWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rejoinTitle">
      <h3 id="rejoinTitle">로봇이 합류했습니다</h3>
      <p id="rejoinMsg" style="color:#475569">원래 목적지로 안내를 다시 시작할까요?</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="rejoinNo" class="btn">아니요</button>
        <button id="rejoinYes" class="btn success">예, 다시 안내</button>
      </div>
    </div>
  </div>

  <!-- 전역 에러 캐처 + 구형 브라우저 경고 -->
  <script>
    window.addEventListener('error', function (e) {
      alert('스크립트 오류: ' + (e && e.message ? e.message : '알 수 없음'));
    });
    (function(){
      try { eval('var t={a:1}; t?.a'); }
      catch (e) {
        alert('브라우저/웹뷰가 너무 오래되었습니다. 최신 크롬/삼성인터넷으로 열어주세요.');
      }
    })();
  </script>

  <script>
    'use strict';

    /***** 실제 운영 모드 *****/
    var DEV_FORCE_NAV = false;
    var DEV_MOCK_PATH = false;
    var DEV_ETA_SEC   = 0;

    /***** 서버 접속 정보 (반드시 교체) *****/
    var BACKEND_URL = "https://page-paragraphs-pounds-ripe.trycloudflare.com";
    var API_KEY     = "dev-secret";

    /***** 세션 아이디 (로컬 고정) *****/
    function getSessionId(){
      try{
        var id = localStorage.getItem('SESSION_ID');
        if(!id){
          id = 'sess_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
          localStorage.setItem('SESSION_ID', id);
        }
        return id;
      }catch(e){
        // 로컬스토리지 불가 환경
        return 'sess_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
    }
    var SESSION_ID = getSessionId();

    /***** 상태 플래그 *****/
    var currentFloor=1, pendingTarget=null;
    var guiding=false, paused=false, pollingTimer=null, activeRoom=null;
    var summoning=false;            // 소환(복귀 호출)
    var rendezvous=false;           // 재합류(사용자 위치로 이동)
    var lastStatus=null;
    var activeLabel=null;           // 목적지 라벨 보존(도착 모달 표기를 위해)
    var resumeTarget=null;          // 재합류 후 재안내할 원래 목적지 {code,label}
    var rendezvousRoom=null;        // 사용자가 입력한 합류 호실

    /***** 호실/라벨 데이터 (정적) *****/
    var ROOM_INFO={
      1:{"101":"정보통신대학 학장실","102":"전자공학과 학과사무실","102-1":"스마트ICT융합공학과 학과사무실","103":"연구용실험실","104":"강의실","105":"연구용실험실","106":"해동학술정보실","107":"강의실","108":"강의실","109":"강의실","110":"강의실","111":"강의실","112":"강의실","113":"강의실","114":"극한반도체 회로/소자 특성분석실","115":"강의실","116":"강의실","117":"강의실","119":"강의실","120":"강의실","121":"강의실","122":"연구용실험실","123":"강의실","124":"멘토링실","125":"공동동아리방","126":"안전공학과 학생회실","127":"강의실","128":"전자공학과 학생회실","129":"정보통신대학 행정실","130":"강의실","131":"외래교수실","132":"정보통신대학 학생쉼터","133":"연구용실험실","134":"강의실","135":"강의실","136":"연구용실험실","137":"연구용실험실"},
      2:{"201":"전자공학과회의실","201-1":"전자공학과 교수휴게실","202":"신일훈 교수연구실","203":"이병한 교수연구실","204":"박형철 교수연구실","205":"권민우 교수연구실","206":"남재원 교수연구실","207":"실습준비실","207-1":"강의실","208":"아날로그전자실험실습실","209":"마이크로프로세서연구실","210":"프로젝트실습실","210-1":"강의실","211":"인공지능연구실","212":"NX연구실","212-1":"운영체제연구실","213":"반도체소자연구실","213-1":"강의실","214":"회로설계연구실","215":"무선통신연구실","216":"종합설계(작업)실","217":"전자기수치해석연구실","218":"전자시뮬레이션실험실습실","219":"컴퓨터구조연구실","220":"컴퓨터구조연구실","221":"지능제어연구실","222":"컴퓨터실","223":"신호처리연구실","223-1":"강의실","224":"최승호 교수연구실","225":"박민기 교수연구실","226":"도현락 교수연구실","227":"경연웅 교수연구실","228":"양성준 교수연구실","229":"이승은 교수연구실","230":"정태호 교수연구실","231":"이예훈 교수연구실","232":"강의실","233":"유비쿼터스컴퓨팅연구실","233-1":"아날로그집적회로설계연구실","234":"유비쿼터스컴퓨팅연구실","235":"종합설계제작실","236":"강의실"},
      3:{"301":"김성권 교수연구실","301-1":"강의실","302":"최현덕 교수연구실","303":"강의실","304":"황병철 교수연구실","305":"이원영 교수연구실","306":"최의민 교수연구실","307":"김화정 교수연구실","308":"영상처리실험실","308-1":"강의실","309":"강의실","309-1":"연구용실험실","309-2":"연구용실험실","310":"교수회의실","311":"멀티미디어회로시스템실험실","312":"ICT회로계측실험실","313":"스마트미디어네트워크실험실","314":"스마트ICT융합공학과 학생회실","315":"기자재실","316":"협동적시스템소프트웨어연구실","317":"멀티미디어실험실","318":"전기전자회로실험실","318-1":"강의실","319":"음향공학실","320":"ICT융합실험실","320-1":"강의실","321":"머신러닝실험실","322":"실감미디어연구실","323":"미디어시뮬레이션실험실","324":"강의실","325":"강의실","326":"강의실","327":"서범준 교수연구실","328":"차병준 교수연구실","329":"이계민 교수연구실","330":"박구만 교수연구실","331":"허성연 교수연구실","332":"정현민 교수연구실","333":"박규태 교수연구실","334":"김동호 교수연구실","334-1":"호수에 오브레곤 교수연구실","335":"전력전자시스템실험실","335-1":"전력전자시스템실험실","336":"로봇지능 및 제어 연구실","337":"집적회로설계실험실","338":"강의실","339":"강의실","340":"강의실","341":"ICT융합공학교육실","342":"ICT공학실험실습실"}
    };
    var RANGES={1:[101,137],2:[201,235],3:[301,342]};

    function $(sel){ try { return document.querySelector(sel); } catch(_) { return null; } }
    function on(id, evt, fn){
      var el = document.getElementById(id);
      if (el) el.addEventListener(evt, fn, false);
    }

    function showPage(id){
      var pages = document.querySelectorAll('.page');
      for(var i=0;i<pages.length;i++){ pages[i].classList.remove('active'); }
      var el=document.getElementById(id);
      if(el) el.classList.add('active');
      if(id==='page-home'){ document.body.classList.add('home-active'); }
      else { document.body.classList.remove('home-active'); }
    }
    function goHome(){
      stopPolling(); stopMock();
      guiding=false; paused=false; activeRoom=null; summoning=false; activeLabel=null;
      rendezvous=false; resumeTarget=null; rendezvousRoom=null;
      setActiveTab(1); showPage('page-home');
    }
    function goBack(){
      var pg=document.getElementById('page-guide');
      var pf=document.getElementById('page-floor');
      var ps=document.getElementById('page-summon');
      if(pg && pg.classList.contains('active')){ showPage('page-floor'); return; }
      if(pf && pf.classList.contains('active')) goHome();
      else if(ps && ps.classList.contains('active')) goHome();
      else showPage('page-home');
    }
    function setActiveTab(f){
      [1,2,3].forEach(function(x){
        var el=document.getElementById('tab-' + x);
        if(el) el.classList.toggle('active', x===f);
      });
    }
    function startGuide(){ openFloor(1); showPage('page-floor'); }
    function openFloor(f){
      currentFloor=f; setActiveTab(f);
      var tag=document.getElementById('floorTag'); if(tag) tag.textContent=f+'층';
      buildRoomsForFloor(f);
    }

    function addRoomCard(code,label){
      var c=document.createElement('div'); c.className='room';
      var num=document.createElement('div'); num.className='num'; num.textContent=code+'호'; c.appendChild(num);
      var lab=document.createElement('div'); lab.className='label'; lab.textContent=label||''; c.appendChild(lab);
      c.addEventListener('click', function(){
        if(code.indexOf('-')>=0){
          alert('이 호실은 현재 안내 비활성(백엔드 room:int). 필요시 백엔드를 room:str로 변경하세요.');
          return;
        }
        openConfirm(code,label);
      });
      var box=document.getElementById('roomList'); if(box) box.appendChild(c);
    }
    function buildRoomsForFloor(f){
      var box=document.getElementById('roomList'); if(!box) return;
      box.innerHTML='';
      var range=RANGES[f]||[0,-1]; var s=range[0], e=range[1];
      for(var n=s;n<=e;n++){
        var code=String(n);
        if(ROOM_INFO[f][code]) addRoomCard(code,ROOM_INFO[f][code]);
        var k, rooms=ROOM_INFO[f];
        for(k in rooms){
          if(rooms.hasOwnProperty(k) && k.indexOf(code+"-")===0) addRoomCard(k, rooms[k]);
        }
      }
    }
    function filterRooms(){
      var input=document.getElementById('searchInput'); var box=document.getElementById('roomList');
      if(!input||!box) return;
      var q=input.value.trim().toLowerCase();
      box.innerHTML='';
      if(!q){ buildRoomsForFloor(currentFloor); return; }
      Object.keys(ROOM_INFO).forEach(function(fk){
        var rooms=ROOM_INFO[fk];
        Object.keys(rooms).forEach(function(code){
          var label=rooms[code];
          if(code.toLowerCase().indexOf(q)>=0 || (label && String(label).toLowerCase().indexOf(q)>=0)) addRoomCard(code,label);
        });
      });
    }
    function clearSearch(){ var i=document.getElementById('searchInput'); if(i){ i.value=''; filterRooms(); } }

    function openConfirm(code,label){
      pendingTarget={code:code,label:label};
      var msg=document.getElementById('confirmMsg'); if(msg) msg.textContent=code+'호 '+(label||'')+' 로 안내할까요?';
      var wrap=document.getElementById('confirmWrap'); if(wrap){ wrap.classList.add('show'); }
    }
    function closeConfirm(){ var w=document.getElementById('confirmWrap'); if(w) w.classList.remove('show'); pendingTarget=null; }

    function api(path, method, body){
      method = method || "GET";
      var url = BACKEND_URL.replace(/\\/+$/,'') + path;
      var opt={ method:method, headers: { 'x-api-key': API_KEY, 'x-session-id': SESSION_ID } };
      if(body){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
      return fetch(url, opt).then(function(r){
        var ct=r.headers.get('content-type')||'';
        if(r.status===423){
          if(ct.indexOf('application/json')>=0){
            return r.json().then(function(j){ throw new Error('LOCKED:'+(j && j.detail ? j.detail : 'Locked')); });
          } else {
            throw new Error('LOCKED:Robot locked by another session');
          }
        }
        if(!r.ok){
          if(ct.indexOf('application/json')>=0){
            return r.json().then(function(j){ throw new Error((j && j.detail)? String(j.detail) : ('HTTP '+r.status)); });
          }
          throw new Error('HTTP '+r.status);
        }
        if(ct.indexOf('application/json')>=0) return r.json();
        return r.text();
      });
    }

    function confirmNavigate(){
      if(!pendingTarget) return;
      var yes=document.getElementById('confirmYes'), no=document.getElementById('confirmNo');
      [yes,no].forEach(function(b){ if(b) b.disabled=true; });

      var target=pendingTarget; closeConfirm();

      api('/api/navigate','POST',{ room: Number(target.code) }).then(function(){
        activeRoom=target.code;
        activeLabel=target.label || null;
        guiding=true; paused=false; summoning=false; rendezvous=false; resumeTarget=null; rendezvousRoom=null;
        var g=document.getElementById('goalText'); if(g) g.textContent=target.code+'호'+(activeLabel?(' ('+activeLabel+')'):'');
        var s=document.getElementById('guideStatus'); if(s) s.textContent='안내 시작됨';
        var pb=document.getElementById('pauseBtn'); if(pb) pb.textContent='정지';
        showPage('page-guide');
        startPolling();
      }).catch(function(e){
        if(String(e && e.message || '').indexOf('LOCKED:')===0){
          alert('현재 다른 사용자가 안내를 진행 중입니다. 잠시 후 다시 이용해 주세요.');
        }else{
          alert('안내 시작 실패: '+ (e && e.message ? e.message : '알 수 없는 오류'));
        }
        [yes,no].forEach(function(b){ if(b) b.disabled=false; });
      });
    }

    function togglePause(){
      if(!guiding) return;
      var pb=document.getElementById('pauseBtn'), sb=document.getElementById('stopBtn'), lb=document.getElementById('lostBtn');
      [pb,sb,lb].forEach(function(b){ if(b) b.disabled=true; });
      var p = paused ? api('/api/resume','POST') : api('/api/stop','POST');
      p.then(function(){
        paused = !paused;
        if(pb) pb.textContent = paused ? '안내 재개' : '정지';
        var s=document.getElementById('guideStatus'); if(s) s.textContent= paused ? '일시 정지됨' : '안내중';
      }).catch(function(e){
        if(String(e && e.message || '').indexOf('LOCKED:')===0){
          alert('현재 다른 세션이 제어 중입니다.');
        }else{
          alert('동작 실패: '+ (e && e.message ? e.message : '연결 상태를 확인하세요.'));
        }
      }).finally(function(){
        [pb,sb,lb].forEach(function(b){ if(b) b.disabled=false; });
      });
    }
    function stopGuide(){
      var pb=document.getElementById('pauseBtn'), sb=document.getElementById('stopBtn'), lb=document.getElementById('lostBtn');
      [pb,sb,lb].forEach(function(b){ if(b) b.disabled=true; });
      api('/api/stop','POST').catch(function(e){ console.warn(e); }).finally(function(){
        guiding=false; paused=false; activeRoom=null; activeLabel=null; rendezvous=false; resumeTarget=null; rendezvousRoom=null;
        stopPolling(); stopMock(); showPage('page-floor');
        [pb,sb,lb].forEach(function(b){ if(b) b.disabled=false; });
      });
    }

    function startPolling(){
      stopPolling();
      ensureMap().then(function(){ /* noop */ }).catch(function(){ /* noop */ }).finally(function(){
        pollingTimer=window.setInterval(fetchStatus,1000);
        fetchStatus();
      });
    }
    function stopPolling(){ if(pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; } }

    function fetchStatus(){
      api('/api/status','GET').then(function(status){
        lastStatus=status;

        // 소환/재합류 진행 중이면 상태 표시 업데이트
        if(summoning || rendezvous){
          var t=document.getElementById('summonStatus');
          if(t){
            if(status && status.current) t.textContent = '현재 위치: '+fmtXY(status.current);
            else t.textContent = '연결 대기중…';
          }
        }

        // 안내중 UI 갱신
        if(guiding) updateGuideUI(status);

        // 도착 처리
        if(status && status.arrived){
          stopPolling();
          if(summoning){
            summoning=false; openFloor(1); showPage('page-floor');
          }else if(rendezvous){
            openRejoinModal();
          }else if(guiding){
            openArrivedModal();
          }
        }
      }).catch(function(e){
        if(summoning || rendezvous){
          var t=document.getElementById('summonStatus'); if(t) t.textContent='연결 대기중…';
        }else{
          var s=document.getElementById('guideStatus'); if(s) s.textContent='연결 대기중…';
        }
      });
    }

    /* ===== 도착 모달(UI 유지) ===== */
    function openArrivedModal(){
      var destText = activeRoom ? (activeRoom+'호'+(activeLabel ? (' ('+activeLabel+')') : '')) : '목적지';
      var wrap = document.getElementById('arrivedWrap');
      var dest = document.getElementById('arrivedDest');
      if (wrap && dest) {
        dest.textContent = destText;
        wrap.classList.add('show');
      }
    }
    function handleArrivedReturn(){
      fetch(BACKEND_URL.replace(/\\/+$/,'') + '/api/return', {
        method: 'POST',
        headers: { 'x-api-key': API_KEY, 'x-session-id': SESSION_ID }
      }).catch(function(e){ console.warn(e); }).finally(function(){
        goHome();
        var w=document.getElementById('arrivedWrap'); if(w) w.classList.remove('show');
      });
    }
    function closeArrivedModal(){
      var w=document.getElementById('arrivedWrap'); if(w) w.classList.remove('show');
    }

    /***** 지도 렌더링 *****/
    var mapEl=(function(){
      var c=document.getElementById('mapCanvas');
      if(!c) return null;
      function resize(){
        var rect=c.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        c.width=Math.max(1, Math.floor(rect.width*dpr));
        c.height=Math.max(1, Math.floor(rect.height*dpr));
      }
      var ro=new (window.ResizeObserver || function(fn){ this.observe=function(){window.addEventListener('resize',fn);} })(function(){ resize(); drawMap(lastStatus); });
      try{ ro.observe(c); }catch(e){ window.addEventListener('resize', function(){ resize(); drawMap(lastStatus); }); }
      resize(); return c;
    })();

    var _mapImg=null, _mapMeta=null, _screenFit=null;
    function ensureMap(){
      if(_mapImg && _mapMeta) return Promise.resolve();
      return api('/api/map/meta','GET').then(function(meta){
        _mapMeta = meta;
        var url = BACKEND_URL.replace(/\\/+$/,'') + '/api/map.png';
        return new Promise(function(res,rej){
          var img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload=function(){ _mapImg = img; res(); };
          img.onerror=function(){ rej(new Error('map image load failed')); };
          img.src=url;
        });
      }).catch(function(e){
        console.warn('map load failed', e);
      });
    }

    function computeScreenFit(W,H,iw,ih){
      var s=Math.min(W/iw, H/ih);
      var dx=(W - iw*s)/2, dy=(H - ih*s)/2;
      return {s:s,dx:dx,dy:dy};
    }
    function worldToScreen(pt){
      if(!_mapMeta || !_screenFit) return null;
      var x=pt[0], y=pt[1];
      var res=_mapMeta.resolution;
      var ox=_mapMeta.origin[0], oy=_mapMeta.origin[1];
      var iw=_mapMeta.width, ih=_mapMeta.height;
      var px=(x - ox)/res;
      var py=(y - oy)/res;
      py = (ih - 1) - py;
      var s=_screenFit.s, dx=_screenFit.dx, dy=_screenFit.dy;
      var X = dx + px*s;
      var Y = dy + py*s;
      return [X,Y];
    }

    function updateGuideUI(status){
      if(status && status.current){ var t=document.getElementById('curPosText'); if(t) t.textContent = fmtXY(status.current); }
      if(activeRoom){ var g=document.getElementById('goalText'); if(g) g.textContent = activeRoom+'호'+(activeLabel?(' ('+activeLabel+')'):''); }
      var s=document.getElementById('guideStatus'); if(s) s.textContent = paused ? '일시 정지됨' : '안내중';
      drawMap(status);
    }

    function drawMap(status){
      if(!mapEl) return;
      var c=mapEl, ctx=c.getContext('2d');
      var dpr = window.devicePixelRatio || 1;
      ctx.save(); ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,c.width, c.height);
      var W=c.width/dpr, H=c.height/dpr;

      if(_mapImg && _mapMeta){
        _screenFit = computeScreenFit(W,H,_mapImg.width,_mapImg.height);
        var s=_screenFit.s, dx=_screenFit.dx, dy=_screenFit.dy;
        ctx.drawImage(_mapImg, dx, dy, _mapImg.width*s, _mapImg.height*s);
      }else{
        ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,W,H);
      }

      if(!status || (!status.path && !status.current && !status.goal)){
        ctx.fillStyle='#9ca3af'; ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.textAlign='center';
        ctx.fillText('연결 대기중… (경로/좌표 수신 시 자동 표시)', W/2, H/2);
        ctx.restore(); return;
      }

      if(status.path && status.path.length>=2){
        ctx.lineWidth=3; ctx.strokeStyle='#22c55e';
        ctx.beginPath();
        for(var i=0;i<status.path.length;i++){
          var p=status.path[i];
          var P = worldToScreen(p) || relToScreen(p);
          if(!P) continue;
          if(i===0) ctx.moveTo(P[0],P[1]); else ctx.lineTo(P[0],P[1]);
        }
        ctx.stroke();
      }

      if(status.goal){
        var G = worldToScreen(status.goal) || relToScreen(status.goal);
        if(G){ ctx.fillStyle='#2563eb'; ctx.beginPath(); ctx.arc(G[0],G[1],6,0,Math.PI*2); ctx.fill(); }
      }

      if(status.current){
        var C = worldToScreen(status.current) || relToScreen(status.current);
        if(C){ ctx.fillStyle='#111827'; ctx.beginPath(); ctx.arc(C[0],C[1],6,0,Math.PI*2); ctx.fill(); }
      }

      ctx.restore();

      function relToScreen(pt){
        if(!status) return null;
        var pts=[];
        if(status.path) status.path.forEach(function(p){ if(p && p.length===2) pts.push(p); });
        if(status.current) pts.push(status.current);
        if(status.goal) pts.push(status.goal);
        var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        for(var i=0;i<pts.length;i++){
          var v=pts[i], x=v[0], y=v[1];
          if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y;
        }
        if(!isFinite(minX)){ minX=0;minY=0;maxX=10;maxY=10; }
        var pad=24;
        var sx=(W-2*pad)/Math.max(1e-6,(maxX-minX));
        var sy=(H-2*pad)/Math.max(1e-6,(maxY-minY));
        var s=Math.min(sx,sy);
        var x=pt[0], y=pt[1];
        var X = pad + (x-minX)*s;
        var Y = H - pad - (y-minY)*s;
        return [X,Y];
      }
    }
    function fmtXY(p){ if(!p || p.length<2) return '-'; var x=Number(p[0]||0), y=Number(p[1]||0); return x.toFixed(2)+", "+y.toFixed(2); }

    var _mockTimer=null;
    function startMockRun(){}
    function stopMock(){ if(_mockTimer){ clearInterval(_mockTimer); _mockTimer=null; } }

    /***** 소환(복귀) 흐름 *****/
    function startSummon(){
      api('/api/return','POST').then(function(){
        summoning=true; guiding=false; paused=false; activeRoom=null; activeLabel=null;
        rendezvous=false; resumeTarget=null; rendezvousRoom=null;
        document.getElementById('summonPill').textContent='소환중';
        document.getElementById('summonTitle').textContent='로봇이 열심히 가고 있어요…';
        document.getElementById('summonHint').textContent='로봇이 도착하면 목적지를 선택할 수 있어요.';
        showPage('page-summon');
        startPolling();
      }).catch(function(e){
        if(String(e && e.message || '').indexOf('LOCKED:')===0){
          alert('현재 다른 사용자가 안내를 진행 중입니다. 잠시 후 다시 이용해 주세요.');
        }else{
          alert('로봇 소환 실패: '+(e && e.message ? e.message : '서버 연결 또는 복귀 좌표 설정을 확인하세요.'));
        }
      });
    }

    /***** 재합류 흐름 *****/
    function startLostFlow(){
      api('/api/stop','POST').catch(function(e){ console.warn(e); }).finally(function(){
        paused=true; guiding=false;
        var li=document.getElementById('lostInput'); if(li) li.value='';
        var w=document.getElementById('lostWrap'); if(w) w.classList.add('show');
      });
    }
    function closeLostModal(){ var w=document.getElementById('lostWrap'); if(w) w.classList.remove('show'); }

    function confirmRendezvous(){
      var li=document.getElementById('lostInput'); var val = (li && li.value || '').trim();
      if(!/^[0-9]+$/.test(val)){ alert('호실 번호를 숫자로 입력해 주세요. 예: 101'); return; }

      if(activeRoom){ resumeTarget = { code: activeRoom, label: activeLabel || null }; }
      else { resumeTarget = null; }
      rendezvousRoom = val;

      closeLostModal();
      api('/api/navigate','POST',{ room: Number(val) }).then(function(){
        summoning=false; rendezvous=true;
        document.getElementById('summonPill').textContent='재합류중';
        document.getElementById('summonTitle').textContent='로봇이 '+val+'호 앞으로 이동 중…';
        document.getElementById('summonHint').textContent='로봇이 도착하면 원래 목적지로 재안내를 시작할 수 있어요.';
        showPage('page-summon');
        startPolling();
      }).catch(function(e){
        if(String(e && e.message || '').indexOf('LOCKED:')===0){
          alert('현재 다른 사용자가 안내를 진행 중입니다. 잠시 후 다시 이용해 주세요.');
        }else{
          alert('이동 시작 실패: '+(e && e.message ? e.message : '서버 연결 또는 좌표 설정을 확인하세요.'));
        }
      });
    }

    function openRejoinModal(){
      rendezvous=true;
      var wrap = document.getElementById('rejoinWrap');
      var msg = document.getElementById('rejoinMsg');
      if(msg){
        if(resumeTarget && resumeTarget.code){
          msg.textContent = '원래 목적지('+resumeTarget.code+'호'+(resumeTarget.label?(' ('+resumeTarget.label+')'):'')+')로 안내를 다시 시작할까요?';
        }else{
          msg.textContent = '원래 목적지가 없습니다. 목적지를 선택하시겠어요?';
        }
      }
      if(wrap){ wrap.classList.add('show'); }
    }
    function closeRejoinModal(){ var w=document.getElementById('rejoinWrap'); if(w) w.classList.remove('show'); }

    function rejoinYes(){
      closeRejoinModal();
      if(resumeTarget && resumeTarget.code){
        api('/api/navigate','POST',{ room: Number(resumeTarget.code) }).then(function(){
          activeRoom = String(resumeTarget.code);
          activeLabel = resumeTarget.label || null;
          guiding=true; paused=false; rendezvous=false; summoning=false;
          var gt=document.getElementById('goalText'); if(gt) gt.textContent = activeRoom+'호'+(activeLabel?(' ('+activeLabel+')'):'');
          var gs=document.getElementById('guideStatus'); if(gs) gs.textContent = '안내 시작됨';
          showPage('page-guide');
          startPolling();
        }).catch(function(e){
          if(String(e && e.message || '').indexOf('LOCKED:')===0){
            alert('현재 다른 사용자가 안내를 진행 중입니다.');
          }else{
            alert('재안내 시작 실패: '+(e && e.message ? e.message : '서버 연결을 확인하세요.'));
          }
        });
      } else {
        rendezvous=false; summoning=false; guiding=false; paused=false;
        openFloor(1); showPage('page-floor');
      }
    }
    function rejoinNo(){
      closeRejoinModal();
      rendezvous=false; summoning=false; guiding=false; paused=false;
      openFloor(1); showPage('page-floor');
    }

    document.addEventListener('DOMContentLoaded', function(){
      on('homeBtn','click', goHome);
      on('backBtn','click', goBack);

      on('btnTogether','click', startGuide);
      on('btnSummon','click', startSummon);

      on('tab-1','click', function(){ openFloor(1); });
      on('tab-2','click', function(){ openFloor(2); });
      on('tab-3','click', function(){ openFloor(3); });

      var si = document.getElementById('searchInput');
      if (si) si.addEventListener('input', filterRooms, false);
      on('clearSearchBtn','click', clearSearch);

      on('pauseBtn','click', togglePause);
      on('stopBtn','click', stopGuide);
      on('lostBtn','click', startLostFlow);

      on('confirmNo','click', closeConfirm);
      on('confirmYes','click', confirmNavigate);

      on('arrivedReturn','click', handleArrivedReturn);
      on('arrivedClose','click', closeArrivedModal);

      on('lostClear','click', function(){
        var i=document.getElementById('lostInput'); if(i){ i.value=''; i.focus(); }
      });
      on('lostCancel','click', closeLostModal);
      on('lostGo','click', confirmRendezvous);
      var li = document.getElementById('lostInput');
      if (li) li.addEventListener('keydown', function(e){ if(e.key==='Enter') confirmRendezvous(); }, false);

      on('rejoinYes','click', rejoinYes);
      on('rejoinNo','click', rejoinNo);

      // 혹시 남아 있을 수 있는 오버레이 강제 제거
      var overlays = document.querySelectorAll('.modal-backdrop');
      for (var i=0;i<overlays.length;i++){ overlays[i].classList.remove('show'); }

      document.body.classList.add('home-active');
      showPage('page-home');
    });
  </script>
</body>
</html>
