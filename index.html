<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>실내 길 안내 로봇</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#f3f4f6; --text:#0f172a; --subtle:#6b7280;
      --border:#e5e7eb; --accent:#2563eb; --accent-2:#22c55e; --ring:#60a5fa;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0)}
    body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"맑은 고딕",sans-serif}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:12px 16px;display:flex;align-items:center;gap:8px;background:#ffffffcc;border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border);justify-content:center;color:var(--subtle)}
    header .title{font-size:18px;font-weight:700}
    .spacer{flex:1}

    .btn{border:1px solid var(--border);border-radius:14px;padding:12px 16px;font-weight:700;background:var(--muted);color:var(--text);min-height:44px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--accent-2);color:#052e14}
    .btn.ghost{background:#fff}
    .btn.tab{background:#fff;border-radius:12px;min-height:40px}
    .btn.tab.active{outline:2px solid var(--ring);border-color:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .page{display:none;padding:16px;max-width:980px;margin:0 auto}
    .page.active{display:block}

    .hero{text-align:center;padding:28px 16px 10px}
    .hero h1{font-size:30px;margin:10px 0 8px}

    .grid{display:grid;gap:10px}
    .grid.rooms{grid-template-columns:repeat(3,minmax(0, 1fr))}
    @media (max-width:380px){.grid.rooms{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:540px){.grid.rooms{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:900px){.grid.rooms{grid-template-columns:repeat(5,1fr)}}

    .room{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;gap:4px}
    .room .num{font-weight:800;font-size:17px}
    .room .label{font-size:14px;color:#111827;overflow-wrap:anywhere;word-break:break-word;white-space:normal;text-align:center}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--muted);color:#111827;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}

    .searchBox{flex:1;display:flex;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .searchBox input{flex:1;border:0;outline:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
    .modal-backdrop.show{display:flex}
    .modal{background:#fff;padding:16px;border-radius:16px;width:min(92vw,420px)}

    /* 안내중 페이지 */
    .guide-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .guide-status{font-size:14px;color:var(--subtle)}
    .map-wrap{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    #mapCanvas{width:100%;height:360px;display:block;border-radius:12px;background:#fafafa;border:1px dashed var(--border)}
    .guide-controls{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .legend{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:6px;font-size:13px;color:#374151}
    .legend .i{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.cur{background:#111827}
    .dot.goal{background:#2563eb}
    .line-swatch{width:18px;height:3px;background:#22c55e;border-radius:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button id="backBtn" class="btn ghost">←</button>
      <div class="title">실내 길 안내 로봇</div>
      <div class="spacer"></div>
      <button id="homeBtn" class="btn">홈</button>
    </header>

    <!-- 홈 -->
    <main id="page-home" class="page active">
      <div class="hero">
        <h1>실내 길 안내 서비스</h1>
        <p>QR 접속 → 층/호실 선택 → 로봇 안내</p>
        <button id="startBtn" class="btn primary">안내 시작하기</button>
      </div>
    </main>

    <!-- 층/호실 선택 -->
    <section id="page-floor" class="page">
      <div class="toolbar">
        <span id="floorTag" class="pill">1층</span>
        <div class="tabbar">
          <button id="tab-1" class="btn tab active">1층</button>
          <button id="tab-2" class="btn tab">2층</button>
          <button id="tab-3" class="btn tab">3층</button>
        </div>
        <div class="searchBox">
          <input id="searchInput" type="text" placeholder="호실 번호/이름 검색" />
          <button id="clearSearchBtn" class="btn">지우기</button>
        </div>
      </div>
      <div class="card"><div id="roomList" class="grid rooms"></div></div>
    </section>

    <!-- 안내중 화면 -->
    <section id="page-guide" class="page">
      <div class="guide-header">
        <span class="pill">안내중</span>
        <div class="guide-status" id="guideStatus">연결 대기중…</div>
        <div class="spacer"></div>
      </div>

      <div class="card" style="text-align:center">
        <div><strong>현재 위치:</strong> <span id="curPosText">-</span> &nbsp;|&nbsp; <strong>목적지:</strong> <span id="goalText">-</span></div>
      </div>

      <div class="map-wrap">
        <canvas id="mapCanvas"></canvas>
        <div class="legend">
          <span class="i"><span class="dot cur"></span>현재 위치</span>
          <span class="i"><span class="dot goal"></span>목적지</span>
          <span class="i"><span class="line-swatch"></span>경로</span>
        </div>
      </div>

      <div class="guide-controls">
        <button id="pauseBtn" class="btn">정지</button>
        <button id="stopBtn" class="btn">안내 종료</button>
      </div>
    </section>

    <footer><div>© 2025 Indoor Guide Robot</div></footer>
  </div>

  <!-- 확인 모달 -->
  <div id="confirmWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">안내를 시작할까요?</h3>
      <p id="confirmMsg"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="confirmNo" class="btn">아니요</button>
        <button id="confirmYes" class="btn success">예</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    /***** 실제 운영 모드 *****/
    const DEV_FORCE_NAV = false;   // 실패 통과 금지
    const DEV_MOCK_PATH = false;   // 가짜 경로/도착 금지
    const DEV_ETA_SEC   = 0;       // 사용 안 함

    /***** 서버 접속 정보 (반드시 교체) *****/
    const BACKEND_URL = "https://withdrawal-systematic-img-chrome.trycloudflare.com"; // ← Cloudflare Tunnel 등 실제 주소
    const API_KEY     = "dev-secret";                    // ← 백엔드와 동일

    /***** 호실/라벨 데이터 (정적; 백엔드와 좌표는 room_map.yaml로 관리) *****/
    const ROOM_INFO={
      1:{"101":"정보통신대학 학장실","102":"전자공학과 학과사무실","102-1":"스마트ICT융합공학과 학과사무실","103":"연구용실험실","104":"강의실","105":"연구용실험실","106":"해동학술정보실","107":"강의실","108":"강의실","109":"강의실","110":"강의실","111":"강의실","112":"강의실","113":"강의실","114":"극한반도체 회로/소자 특성분석실","115":"강의실","116":"강의실","117":"강의실","119":"강의실","120":"강의실","121":"강의실","122":"연구용실험실","123":"강의실","124":"멘토링실","125":"공동동아리방","126":"안전공학과 학생회실","127":"강의실","128":"전자공학과 학생회실","129":"정보통신대학 행정실","130":"강의실","131":"외래교수실","132":"정보통신대학 학생쉼터","133":"연구용실험실","134":"강의실","135":"강의실","136":"연구용실험실","137":"연구용실험실"},
      2:{"201":"전자공학과회의실","201-1":"전자공학과 교수휴게실","202":"신일훈 교수연구실","203":"이병한 교수연구실","204":"박형철 교수연구실","205":"권민우 교수연구실","206":"남재원 교수연구실","207":"실습준비실","207-1":"강의실","208":"아날로그전자실험실습실","209":"마이크로프로세서연구실","210":"프로젝트실습실","210-1":"강의실","211":"인공지능연구실","212":"NX연구실","212-1":"운영체제연구실","213":"반도체소자연구실","213-1":"강의실","214":"회로설계연구실","215":"무선통신연구실","216":"종합설계(작업)실","217":"전자기수치해석연구실","218":"전자시뮬레이션실험실습실","219":"컴퓨터구조연구실","220":"컴퓨터구조연구실","221":"지능제어연구실","222":"컴퓨터실","223":"신호처리연구실","223-1":"강의실","224":"최승호 교수연구실","225":"박민기 교수연구실","226":"도현락 교수연구실","227":"경연웅 교수연구실","228":"양성준 교수연구실","229":"이승은 교수연구실","230":"정태호 교수연구실","231":"이예훈 교수연구실","232":"강의실","233":"유비쿼터스컴퓨팅연구실","233-1":"아날로그집적회로설계연구실","234":"유비쿼터스컴퓨팅연구실","235":"종합설계제작실","236":"강의실"},
      3:{"301":"김성권 교수연구실","301-1":"강의실","302":"최현덕 교수연구실","303":"강의실","304":"황병철 교수연구실","305":"이원영 교수연구실","306":"최의민 교수연구실","307":"김화정 교수연구실","308":"영상처리실험실","308-1":"강의실","309":"강의실","309-1":"연구용실험실","309-2":"연구용실험실","310":"교수회의실","311":"멀티미디어회로시스템실험실","312":"ICT회로계측실험실","313":"스마트미디어네트워크실험실","314":"스마트ICT융합공학과 학생회실","315":"기자재실","316":"협동적시스템소프트웨어연구실","317":"멀티미디어실험실","318":"전기전자회로실험실","318-1":"강의실","319":"음향공학실","320":"ICT융합실험실","320-1":"강의실","321":"머신러닝실험실","322":"실감미디어연구실","323":"미디어시뮬레이션실험실","324":"강의실","325":"강의실","326":"강의실","327":"서범준 교수연구실","328":"차병준 교수연구실","329":"이계민 교수연구실","330":"박구만 교수연구실","331":"허성연 교수연구실","332":"정현민 교수연구실","333":"박규태 교수연구실","334":"김동호 교수연구실","334-1":"호수에 오브레곤 교수연구실","335":"전력전자시스템실험실","335-1":"전력전자시스템실험실","336":"로봇지능 및 제어 연구실","337":"집적회로설계실험실","338":"강의실","339":"강의실","340":"강의실","341":"ICT융합공학교육실","342":"ICT공학실험실습실"}
    };
    const RANGES={1:[101,137],2:[201,235],3:[301,342]};

    /***** 상태 변수 *****/
    let currentFloor=1,pendingTarget=null;
    let guiding=false, paused=false, pollingTimer=null, activeRoom=null;
    let lastStatus=null; // {arrived, current:[x,y], goal:[x,y], path:[[x,y],...]}

    const $ = (sel)=>document.querySelector(sel);

    /***** 페이지 전환 *****/
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const el=document.getElementById(id);
      if(el) el.classList.add('active');
    }
    function goHome(){
      stopPolling(); stopMock();
      guiding=false; paused=false; activeRoom=null;
      setActiveTab(1); showPage('page-home');
    }
    function goBack(){
      if($('#page-guide')?.classList.contains('active')){ showPage('page-floor'); return;}
      if($('#page-floor')?.classList.contains('active')) goHome(); else showPage('page-home');
    }
    function startGuide(){ openFloor(1); showPage('page-floor'); }
    function setActiveTab(f){
      [1,2,3].forEach(x=>{
        const el=document.getElementById(`tab-${x}`);
        if(el) el.classList.toggle('active',x===f);
      });
    }

    /***** 방 카드 (하이픈 방은 백엔드 room:int 제한으로 안내 비활성) *****/
    function addRoomCard(code,label){
      const c=document.createElement('div'); c.className='room';
      const num=document.createElement('div'); num.className='num'; num.textContent=code+'호'; c.appendChild(num);
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=label||''; c.appendChild(lab);
      c.addEventListener('click', ()=>{
        if(code.includes('-')){
          alert('이 호실은 현재 안내 비활성(백엔드 room:int). 필요시 백엔드를 room:str로 변경하세요.');
          return;
        }
        openConfirm(code,label);
      });
      const box=document.getElementById('roomList'); if(box) box.appendChild(c);
    }
    function buildRoomsForFloor(f){
      const box=document.getElementById('roomList'); if(!box) return;
      box.innerHTML='';
      const range=RANGES[f]||[0,-1]; const s=range[0], e=range[1];
      for(let n=s;n<=e;n++){
        const code=String(n);
        if(ROOM_INFO[f][code]) addRoomCard(code,ROOM_INFO[f][code]);
        Object.keys(ROOM_INFO[f]).filter(k=>k.startsWith(code+"-")).forEach(hc=>addRoomCard(hc,ROOM_INFO[f][hc]));
      }
    }
    function filterRooms(){
      const input=$('#searchInput'); const box=$('#roomList');
      if(!input||!box) return;
      const q=input.value.trim().toLowerCase();
      box.innerHTML='';
      if(!q){ buildRoomsForFloor(currentFloor); return; }
      Object.values(ROOM_INFO).forEach(rooms=>{
        Object.entries(rooms).forEach(([code,label])=>{
          if(code.toLowerCase().includes(q) || (label&&label.toLowerCase().includes(q))) addRoomCard(code,label);
        });
      });
    }
    function clearSearch(){ const i=$('#searchInput'); if(i){ i.value=''; filterRooms(); } }
    function openFloor(f){ currentFloor=f; setActiveTab(f); const tag=$('#floorTag'); if(tag) tag.textContent=f+'층'; buildRoomsForFloor(f); }

    /***** 확인 모달 *****/
    function openConfirm(code,label){
      pendingTarget={code,label};
      const msg=$('#confirmMsg'); if(msg) msg.textContent=code+'호 '+(label||'')+' 로 안내할까요?';
      $('#confirmWrap')?.classList.add('show');
    }
    function closeConfirm(){ $('#confirmWrap')?.classList.remove('show'); pendingTarget=null; }

    /***** API *****/
    async function api(path, method="GET", body=null){
      const url = BACKEND_URL.replace(/\/+$/,'') + path;
      const opt={ method, headers: { 'x-api-key': API_KEY } };
      if(body){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
      const r=await fetch(url, opt);
      if(!r.ok) throw new Error(method+" "+path+" failed: "+r.status);
      const ct=r.headers.get('content-type')||'';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    /***** 안내 시작 (실패 시 진행 금지) *****/
    async function confirmNavigate(){
      if(!pendingTarget) return;
      const yes=$('#confirmYes'), no=$('#confirmNo');
      [yes,no].forEach(b=>b && (b.disabled=true));

      const target=pendingTarget; closeConfirm();

      try{
        await api('/api/navigate','POST',{ room: Number(target.code) }); // 백엔드 room:int
      }catch(e){
        alert('안내 시작 실패: 서버 연결 또는 좌표 설정을 확인하세요.');
        console.error(e);
        [yes,no].forEach(b=>b && (b.disabled=false));
        return;
      }finally{
        [yes,no].forEach(b=>b && (b.disabled=false));
      }

      activeRoom=target.code; guiding=true; paused=false;
      const g=$('#goalText'); if(g) g.textContent=target.code+'호'+(target.label?(' ('+target.label+')'):'');
      const s=$('#guideStatus'); if(s) s.textContent='안내 시작됨';
      const pb=$('#pauseBtn'); if(pb) pb.textContent='정지';
      showPage('page-guide');
      startPolling(); // 실제 폴링만 사용
    }

    /***** 일시정지/재개 & 종료 (stop/resume 매칭) *****/
    async function togglePause(){
      if(!guiding) return;
      const pb=$('#pauseBtn'), sb=$('#stopBtn');
      [pb,sb].forEach(b=>b && (b.disabled=true));
      try{
        if(!paused){
          await api('/api/stop','POST'); // 일시정지(액션 취소 + 하드스톱)
          paused=true; if(pb) pb.textContent='안내 재개';
          const s=$('#guideStatus'); if(s) s.textContent='일시 정지됨';
        } else {
          await api('/api/resume','POST');
          paused=false; if(pb) pb.textContent='정지';
          const s=$('#guideStatus'); if(s) s.textContent='안내중';
        }
      }catch(e){
        alert('동작 실패: 연결 상태를 확인하세요.');
        console.error(e);
      }finally{
        [pb,sb].forEach(b=>b && (b.disabled=false));
      }
    }
    async function stopGuide(){
      const pb=$('#pauseBtn'), sb=$('#stopBtn');
      [pb,sb].forEach(b=>b && (b.disabled=true));
      try{ await api('/api/stop','POST'); }catch(e){ console.warn(e); }
      guiding=false; paused=false; activeRoom=null;
      stopPolling(); stopMock(); showPage('page-floor');
      [pb,sb].forEach(b=>b && (b.disabled=false));
    }

    /***** 폴링 (실서버) *****/
    function startPolling(){ stopPolling(); ensureMap().finally(()=>{ pollingTimer=window.setInterval(fetchStatus,1000); fetchStatus(); }); }
    function stopPolling(){ if(pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; } }
    async function fetchStatus(){
      try{
        const status=await api('/api/status','GET');
        lastStatus=status;
        updateGuideUI(status);
        if(status && status.arrived){ stopPolling(); openArrivedWindow(); }
      }catch(e){
        const s=$('#guideStatus'); if(s) s.textContent='연결 대기중…';
      }
    }

    /***** 도착 창 *****/
    function openArrivedWindow(){
      const win = window.open("", "_blank");
      if (!win) { alert("팝업 차단을 해제해주세요."); return; }

      var html = "<!doctype html>\n"+
      "<html lang=\"ko\">\n"+
      "<head>\n"+
      "<meta charset=\"utf-8\">\n"+
      "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n"+
      "<title>안내 완료</title>\n"+
      "<style>\n"+
      "  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,\\\"맑은 고딕\\\",sans-serif;margin:0;background:#fff;color:#111}\n"+
      "  .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}\n"+
      "  .card{max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:24px;text-align:center;box-shadow:0 6px 24px rgba(0,0,0,.06)}\n"+
      "  h1{margin:0 0 8px}\n"+
      "  .msg{color:#374151}\n"+
      "  .btn{margin-top:16px;padding:12px 18px;border-radius:12px;border:1px solid #e5e7eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}\n"+
      "</style>\n"+
      "</head>\n"+
      "<body>\n"+
      "  <div class=\"wrap\">\n"+
      "    <div class=\"card\">\n"+
      "      <h1>목적지에 도착하였습니다</h1>\n"+
      "      <div class=\"msg\">이용해 주셔서 감사합니다.</div>\n"+
      "      <button class=\"btn\" id=\"returnBtn\">로봇 복귀</button>\n"+
      "    </div>\n"+
      "  </div>\n"+
      "</body>\n"+
      "</html>";

      win.document.open(); win.document.write(html); win.document.close();

      const btn = win.document.getElementById("returnBtn");
      if(btn){
        btn.addEventListener("click", async ()=>{
          try{
            await fetch(BACKEND_URL.replace(/\/+$/,'') + "/api/return", {
              method: "POST",
              headers: { "x-api-key": API_KEY }
            });
          }catch(e){ console.error("return API failed", e); }
          goHome();
          win.close();
        });
      }
    }

    /***** 지도(캔버스) + 맵 오버레이 *****/
    const mapEl=(function(){
      const c=document.getElementById('mapCanvas');
      if(!c) return null;
      function resize(){
        const rect=c.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        c.width=Math.max(1, Math.floor(rect.width*dpr));
        c.height=Math.max(1, Math.floor(rect.height*dpr));
      }
      const ro=new ResizeObserver(()=>{ resize(); drawMap(lastStatus); });
      ro.observe(c); resize(); return c;
    })();

    let _mapImg=null, _mapMeta=null, _screenFit=null;
    async function ensureMap(){
      if(_mapImg && _mapMeta) return;
      try{
        _mapMeta = await api('/api/map/meta','GET'); // {width,height,resolution,origin:[ox,oy]}
        const url = BACKEND_URL.replace(/\/+$/,'') + '/api/map.png';
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
        _mapImg = img;
      }catch(e){ console.warn('map load failed', e); }
    }

    function computeScreenFit(W,H,iw,ih){
      const s=Math.min(W/iw, H/ih);
      const dx=(W - iw*s)/2, dy=(H - ih*s)/2;
      return {s,dx,dy};
    }
    function worldToScreen(pt){
      if(!_mapMeta || !_screenFit) return null;
      const [x,y]=pt;
      const res=_mapMeta.resolution;
      const ox=_mapMeta.origin[0], oy=_mapMeta.origin[1];
      const iw=_mapMeta.width, ih=_mapMeta.height;
      let px=(x - ox)/res;
      let py=(y - oy)/res;
      py = (ih - 1) - py; // 상하반전
      const {s,dx,dy}=_screenFit;
      const X = dx + px*s;
      const Y = dy + py*s;
      return [X,Y];
    }

    function updateGuideUI(status){
      if(status?.current){ const t=$('#curPosText'); if(t) t.textContent = fmtXY(status.current); }
      if(activeRoom){ const g=$('#goalText'); if(g) g.textContent = activeRoom+'호'+(pendingTarget?.label?(' ('+pendingTarget.label+')'):''); }
      const s=$('#guideStatus'); if(s) s.textContent = paused ? '일시 정지됨' : '안내중';
      drawMap(status);
    }

    function drawMap(status){
      if(!mapEl) return;
      const c=mapEl, ctx=c.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      ctx.save(); ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,c.width, c.height);
      const W=c.width/dpr, H=c.height/dpr;

      if(_mapImg && _mapMeta){
        _screenFit = computeScreenFit(W,H,_mapImg.width,_mapImg.height);
        const {s,dx,dy}=_screenFit;
        ctx.drawImage(_mapImg, dx, dy, _mapImg.width*s, _mapImg.height*s);
      }else{
        ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,W,H);
      }

      if(!status || (!status.path && !status.current && !status.goal)){
        ctx.fillStyle='#9ca3af'; ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.textAlign='center';
        ctx.fillText('연결 대기중… (경로/좌표 수신 시 자동 표시)', W/2, H/2);
        ctx.restore(); return;
      }

      if(Array.isArray(status.path) && status.path.length>=2){
        ctx.lineWidth=3; ctx.strokeStyle='#22c55e';
        ctx.beginPath();
        status.path.forEach(function(p,i){
          const P = worldToScreen(p) || relToScreen(p);
          if(!P) return;
          if(i===0) ctx.moveTo(P[0],P[1]); else ctx.lineTo(P[0],P[1]);
        });
        ctx.stroke();
      }

      if(Array.isArray(status.goal)){
        const G = worldToScreen(status.goal) || relToScreen(status.goal);
        if(G){ ctx.fillStyle='#2563eb'; ctx.beginPath(); ctx.arc(G[0],G[1],6,0,Math.PI*2); ctx.fill(); }
      }

      if(Array.isArray(status.current)){
        const C = worldToScreen(status.current) || relToScreen(status.current);
        if(C){ ctx.fillStyle='#111827'; ctx.beginPath(); ctx.arc(C[0],C[1],6,0,Math.PI*2); ctx.fill(); }
      }

      ctx.restore();

      function relToScreen(pt){
        if(!status) return null;
        const pts=[];
        if(Array.isArray(status.path)) status.path.forEach(p=>Array.isArray(p)&&p.length===2&&pts.push(p));
        if(Array.isArray(status.current)) pts.push(status.current);
        if(Array.isArray(status.goal)) pts.push(status.goal);
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        pts.forEach(function(v){ const x=v[0], y=v[1]; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
        if(!isFinite(minX)){ minX=0;minY=0;maxX=10;maxY=10; }
        const pad=24;
        const sx=(W-2*pad)/Math.max(1e-6,(maxX-minX));
        const sy=(H-2*pad)/Math.max(1e-6,(maxY-minY));
        const s=Math.min(sx,sy);
        const x=pt[0], y=pt[1];
        const X = pad + (x-minX)*s;
        const Y = H - pad - (y-minY)*s;
        return [X,Y];
      }
    }
    function fmtXY(p){ if(!Array.isArray(p)) return '-'; const x=Number(p[0]||0), y=Number(p[1]||0); return x.toFixed(2)+", "+y.toFixed(2); }

    /***** 디버그 가짜 이동(운영 비활성) *****/
    let _mockTimer=null;
    function startMockRun(){ /* 운영 모드에선 사용 안 함 */ }
    function stopMock(){ if(_mockTimer){ clearInterval(_mockTimer); _mockTimer=null; } }

    /***** 이벤트 바인딩 *****/
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#homeBtn')?.addEventListener('click', goHome);
      $('#backBtn')?.addEventListener('click', goBack);
      $('#startBtn')?.addEventListener('click', ()=>{ openFloor(1); showPage('page-floor'); });

      document.getElementById('tab-1')?.addEventListener('click', ()=>openFloor(1));
      document.getElementById('tab-2')?.addEventListener('click', ()=>openFloor(2));
      document.getElementById('tab-3')?.addEventListener('click', ()=>openFloor(3));

      $('#searchInput')?.addEventListener('input', filterRooms);
      $('#clearSearchBtn')?.addEventListener('click', clearSearch);

      $('#pauseBtn')?.addEventListener('click', togglePause);
      $('#stopBtn')?.addEventListener('click', stopGuide);

      $('#confirmNo')?.addEventListener('click', closeConfirm);
      $('#confirmYes')?.addEventListener('click', confirmNavigate);

      showPage('page-home');
    });
  </script>
</body>
</html>





