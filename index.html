<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>실내 길안내 서비스</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#f3f4f6; --text:#0f172a; --subtle:#6b7280;
      --border:#e5e7eb; --accent:#2563eb; --accent-2:#22c55e; --ring:#60a5fa;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0)}
    body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"맑은 고딕",sans-serif}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

    footer{padding:12px 16px;display:flex;align-items:center;gap:8px;background:#ffffffcc;border-top:1px solid var(--border);justify-content:center;color:var(--subtle)}

    header{
      padding:12px 16px;
      background:#ffffffcc;
      border-bottom:1px solid var(--border);
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:8px;
    }
    header .title{
      grid-column:2;
      justify-self:center;
      font-size:18px;
      font-weight:700;
    }
    .spacer{ display:none; }
    .home-active #backBtn, .home-active #homeBtn { display:none; }

    .btn{border:1px solid var(--border);border-radius:14px;padding:12px 16px;font-weight:700;background:var(--muted);color:var(--text);min-height:44px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--accent-2);color:#052e14}
    .btn.ghost{background:#fff}
    .btn.tab{background:#fff;border-radius:12px;min-height:40px}
    .btn.tab.active{outline:2px solid var(--ring);border-color:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .page{display:none;padding:16px;max-width:980px;margin:0 auto}
    .page.active{display:block}

    /* 홈 */
    #page-home .hero{
      min-height:calc(100dvh - 120px);
      display:grid;
      place-items:center;
      text-align:center;
      gap:8px;
    }
    #page-home .hero h1{font-size:30px;margin:0 0 8px}
    #page-home .hero .sub{color:#374151}
    #page-home .btn-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:min(520px,92vw);
      margin-top:12px;
    }
    #btnTogether{padding:18px 20px;font-size:18px;border-radius:16px}
    #btnSummon{padding:18px 20px;font-size:18px;border-radius:16px;background:#fff}

    .grid{display:grid;gap:10px}
    .grid.rooms{grid-template-columns:repeat(3,minmax(0, 1fr))}
    @media (max-width:380px){.grid.rooms{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:540px){.grid.rooms{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:900px){.grid.rooms{grid-template-columns:repeat(5,1fr)}}

    .room{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;gap:4px}
    .room .num{font-weight:800;font-size:17px}
    .room .label{font-size:14px;color:#111827;overflow-wrap:anywhere;word-break:break-word;white-space:normal;text-align:center}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--muted);color:#111827;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}

    .searchBox{flex:1;display:flex;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .searchBox input{flex:1;border:0;outline:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
    .modal-backdrop.show{display:flex}
    .modal{background:#fff;padding:16px;border-radius:16px;width:min(92vw,420px)}

    /* 안내중 */
    .guide-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .guide-status{font-size:14px;color:var(--subtle)}
    .map-wrap{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    #mapCanvas{width:100%;height:360px;display:block;border-radius:12px;background:#fafafa;border:1px dashed var(--border)}
    .guide-controls{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .legend{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:6px;font-size:13px;color:#374151}
    .legend .i{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.cur{background:#111827}
    .dot.goal{background:#2563eb}
    .line-swatch{width:18px;height:3px;background:#22c55e;border-radius:2px}

    /* 소환 페이지 */
    #page-summon .center{
      min-height:calc(100dvh - 160px);
      display:grid;
      place-items:center;
      text-align:center;
      gap:8px;
    }
    #page-summon h2{margin:0}
    #page-summon .hint{color:#374151}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button id="backBtn" class="btn ghost">←</button>
      <div class="title">실내 길안내 서비스</div>
      <div class="spacer"></div>
      <button id="homeBtn" class="btn">홈</button>
    </header>

    <!-- 홈 -->
    <main id="page-home" class="page active">
      <div class="hero">
        <div>
          <h1>3어디로 안내할까요?</h1>
          <div class="sub">자리에 로봇이 근처에 있다면 함께 출발해요</div>
          <div class="sub">멀리 있다면 로봇이 먼저 찾아갈게요</div>
        </div>
        <div class="btn-row">
          <button id="btnTogether" class="btn primary">로봇과 함께 있어요</button>
          <button id="btnSummon" class="btn">로봇이 보이지 않아요</button>
        </div>
      </div>
    </main>

    <!-- 소환(복귀/재합류) 진행 화면 -->
    <section id="page-summon" class="page">
      <div class="center">
        <div class="pill" id="summonPill">소환중</div>
        <h2 id="summonTitle">로봇이 열심히 가고 있어요…</h2>
        <div class="hint" id="summonStatus">연결 대기중…</div>
        <div class="hint" id="summonHint">로봇이 도착하면 목적지를 선택할 수 있어요.</div>
      </div>
    </section>

    <!-- 층/호실 선택 -->
    <section id="page-floor" class="page">
      <div class="toolbar">
        <span id="floorTag" class="pill">1층</span>
        <div class="tabbar">
          <button id="tab-1" class="btn tab active">1층</button>
          <button id="tab-2" class="btn tab">2층</button>
          <button id="tab-3" class="btn tab">3층</button>
        </div>
        <div class="searchBox">
          <input id="searchInput" type="text" placeholder="호실 번호/이름 검색" />
          <button id="clearSearchBtn" class="btn">지우기</button>
        </div>
      </div>
      <div class="card"><div id="roomList" class="grid rooms"></div></div>
    </section>

    <!-- 안내중 화면 -->
    <section id="page-guide" class="page">
      <div class="guide-header">
        <span class="pill">안내중</span>
        <div class="guide-status" id="guideStatus">연결 대기중…</div>
        <div class="spacer"></div>
      </div>

      <div class="card" style="text-align:center">
        <div><strong>현재 위치:</strong> <span id="curPosText">-</span> &nbsp;|&nbsp;
             <strong>목적지:</strong> <span id="goalText">-</span></div>
      </div>

      <div class="map-wrap">
        <canvas id="mapCanvas"></canvas>
        <div class="legend">
          <span class="i"><span class="dot cur"></span>현재 위치</span>
          <span class="i"><span class="dot goal"></span>목적지</span>
          <span class="i"><span class="line-swatch"></span>경로</span>
        </div>
      </div>

      <div class="guide-controls">
        <button id="pauseBtn" class="btn">정지</button>
        <button id="stopBtn" class="btn">목적지 변경</button>
        <!-- ▼ 신규: 로봇이 보이지 않을 때 -->
        <button id="lostBtn" class="btn">로봇이 보이지 않아요</button>
      </div>
    </section>

    <footer><div>© 2025 Indoor Guide Robot</div></footer>
  </div>

  <!-- 안내 시작 확인 모달 -->
  <div id="confirmWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">안내를 시작할까요?</h3>
      <p id="confirmMsg"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="confirmNo" class="btn">아니요</button>
        <button id="confirmYes" class="btn success">예</button>
      </div>
    </div>
  </div>

  <!-- ◆ 도착 모달(인페이지, 팝업 무사용) -->
  <div id="arrivedWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="arrivedTitle">
      <h3 id="arrivedTitle">목적지에 도착하였습니다</h3>
      <p id="arrivedDesc" style="color:#475569">이용해 주셔서 감사합니다.</p>
      <div id="arrivedDest" class="pill" style="margin:8px 0;display:inline-block"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="arrivedReturn" class="btn success">로봇 복귀</button>
        <button id="arrivedClose" class="btn">닫기</button>
      </div>
    </div>
  </div>

  <!-- ▼ 신규: 로봇이 보이지 않을 때 입력 모달 -->
  <div id="lostWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lostTitle">
      <h3 id="lostTitle">지금 옆의 호실을 입력해 주세요</h3>
      <p style="color:#475569;margin-top:4px">예: 101, 215 등. 로봇이 해당 호실 앞으로 이동해 합류합니다.</p>
      <div class="searchBox" style="margin-top:8px">
        <input id="lostInput" type="text" inputmode="numeric" pattern="[0-9\-]*" placeholder="호실 번호 (숫자만)" />
        <button id="lostClear" class="btn">지우기</button>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="lostCancel" class="btn">취소</button>
        <button id="lostGo" class="btn success">이 위치로 오기</button>
      </div>
    </div>
  </div>

  <!-- ▼ 신규: 재안내 시작 확인 모달 -->
  <div id="rejoinWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rejoinTitle">
      <h3 id="rejoinTitle">로봇이 합류했습니다</h3>
      <p id="rejoinMsg" style="color:#475569">원래 목적지로 안내를 다시 시작할까요?</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="rejoinNo" class="btn">아니요</button>
        <button id="rejoinYes" class="btn success">예, 다시 안내</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    /***** 실제 운영 모드 *****/
    const DEV_FORCE_NAV = false;
    const DEV_MOCK_PATH = false;
    const DEV_ETA_SEC   = 0;

    /***** 서버 접속 정보 (반드시 교체) *****/
    const BACKEND_URL = "https://samba-presents-fluid-reproduction.trycloudflare.com";
    const API_KEY     = "dev-secret";

    /***** 상태 플래그 *****/
    let currentFloor=1,pendingTarget=null;
    let guiding=false, paused=false, pollingTimer=null, activeRoom=null;
    let summoning=false;            // 기존: 소환(복귀 호출)
    let rendezvous=false;           // 신규: 재합류(사용자 위치로 이동)
    let lastStatus=null;
    let activeLabel=null;           // 목적지 라벨 보존(도착 모달 표기를 위해)
    let resumeTarget=null;          // 신규: 재합류 후 재안내할 원래 목적지 {code,label}
    let rendezvousRoom=null;        // 신규: 사용자가 입력한 합류 호실

    /***** 호실/라벨 데이터 (정적) *****/
    const ROOM_INFO={
      1:{"101":"정보통신대학 학장실","102":"전자공학과 학과사무실","102-1":"스마트ICT융합공학과 학과사무실","103":"연구용실험실","104":"강의실","105":"연구용실험실","106":"해동학술정보실","107":"강의실","108":"강의실","109":"강의실","110":"강의실","111":"강의실","112":"강의실","113":"강의실","114":"극한반도체 회로/소자 특성분석실","115":"강의실","116":"강의실","117":"강의실","119":"강의실","120":"강의실","121":"강의실","122":"연구용실험실","123":"강의실","124":"멘토링실","125":"공동동아리방","126":"안전공학과 학생회실","127":"강의실","128":"전자공학과 학생회실","129":"정보통신대학 행정실","130":"강의실","131":"외래교수실","132":"정보통신대학 학생쉼터","133":"연구용실험실","134":"강의실","135":"강의실","136":"연구용실험실","137":"연구용실험실"},
      2:{"201":"전자공학과회의실","201-1":"전자공학과 교수휴게실","202":"신일훈 교수연구실","203":"이병한 교수연구실","204":"박형철 교수연구실","205":"권민우 교수연구실","206":"남재원 교수연구실","207":"실습준비실","207-1":"강의실","208":"아날로그전자실험실습실","209":"마이크로프로세서연구실","210":"프로젝트실습실","210-1":"강의실","211":"인공지능연구실","212":"NX연구실","212-1":"운영체제연구실","213":"반도체소자연구실","213-1":"강의실","214":"회로설계연구실","215":"무선통신연구실","216":"종합설계(작업)실","217":"전자기수치해석연구실","218":"전자시뮬레이션실험실습실","219":"컴퓨터구조연구실","220":"컴퓨터구조연구실","221":"지능제어연구실","222":"컴퓨터실","223":"신호처리연구실","223-1":"강의실","224":"최승호 교수연구실","225":"박민기 교수연구실","226":"도현락 교수연구실","227":"경연웅 교수연구실","228":"양성준 교수연구실","229":"이승은 교수연구실","230":"정태호 교수연구실","231":"이예훈 교수연구실","232":"강의실","233":"유비쿼터스컴퓨팅연구실","233-1":"아날로그집적회로설계연구실","234":"유비쿼터스컴퓨팅연구실","235":"종합설계제작실","236":"강의실"},
      3:{"301":"김성권 교수연구실","301-1":"강의실","302":"최현덕 교수연구실","303":"강의실","304":"황병철 교수연구실","305":"이원영 교수연구실","306":"최의민 교수연구실","307":"김화정 교수연구실","308":"영상처리실험실","308-1":"강의실","309":"강의실","309-1":"연구용실험실","309-2":"연구용실험실","310":"교수회의실","311":"멀티미디어회로시스템실험실","312":"ICT회로계측실험실","313":"스마트미디어네트워크실험실","314":"스마트ICT융합공학과 학생회실","315":"기자재실","316":"협동적시스템소프트웨어연구실","317":"멀티미디어실험실","318":"전기전자회로실험실","318-1":"강의실","319":"음향공학실","320":"ICT융합실험실","320-1":"강의실","321":"머신러닝실험실","322":"실감미디어연구실","323":"미디어시뮬레이션실험실","324":"강의실","325":"강의실","326":"강의실","327":"서범준 교수연구실","328":"차병준 교수연구실","329":"이계민 교수연구실","330":"박구만 교수연구실","331":"허성연 교수연구실","332":"정현민 교수연구실","333":"박규태 교수연구실","334":"김동호 교수연구실","334-1":"호수에 오브레곤 교수연구실","335":"전력전자시스템실험실","335-1":"전력전자시스템실험실","336":"로봇지능 및 제어 연구실","337":"집적회로설계실험실","338":"강의실","339":"강의실","340":"강의실","341":"ICT융합공학교육실","342":"ICT공학실험실습실"}
    };
    const RANGES={1:[101,137],2:[201,235],3:[301,342]};

    const $ = (sel)=>document.querySelector(sel);

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const el=document.getElementById(id);
      if(el) el.classList.add('active');
      document.body.classList.toggle('home-active', id==='page-home');
    }
    function goHome(){
      stopPolling(); stopMock();
      guiding=false; paused=false; activeRoom=null; summoning=false; activeLabel=null;
      rendezvous=false; resumeTarget=null; rendezvousRoom=null;
      setActiveTab(1); showPage('page-home');
    }
    function goBack(){
      if($('#page-guide')?.classList.contains('active')){ showPage('page-floor'); return;}
      if($('#page-floor')?.classList.contains('active')) goHome();
      else if($('#page-summon')?.classList.contains('active')) goHome();
      else showPage('page-home');
    }
    function setActiveTab(f){
      [1,2,3].forEach(x=>{
        const el=document.getElementById(`tab-${x}`);
        if(el) el.classList.toggle('active',x===f);
      });
    }
    function startGuide(){ openFloor(1); showPage('page-floor'); }
    function openFloor(f){ currentFloor=f; setActiveTab(f); const tag=$('#floorTag'); if(tag) tag.textContent=f+'층'; buildRoomsForFloor(f); }

    function addRoomCard(code,label){
      const c=document.createElement('div'); c.className='room';
      const num=document.createElement('div'); num.className='num'; num.textContent=code+'호'; c.appendChild(num);
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=label||''; c.appendChild(lab);
      c.addEventListener('click', ()=>{
        if(code.includes('-')){
          alert('이 호실은 현재 안내 비활성(백엔드 room:int). 필요시 백엔드를 room:str로 변경하세요.');
          return;
        }
        openConfirm(code,label);
      });
      const box=document.getElementById('roomList'); if(box) box.appendChild(c);
    }
    function buildRoomsForFloor(f){
      const box=document.getElementById('roomList'); if(!box) return;
      box.innerHTML='';
      const range=RANGES[f]||[0,-1]; const s=range[0], e=range[1];
      for(let n=s;n<=e;n++){
        const code=String(n);
        if(ROOM_INFO[f][code]) addRoomCard(code,ROOM_INFO[f][code]);
        Object.keys(ROOM_INFO[f]).filter(k=>k.startsWith(code+"-")).forEach(hc=>addRoomCard(hc,ROOM_INFO[f][hc]));
      }
    }
    function filterRooms(){
      const input=$('#searchInput'); const box=$('#roomList');
      if(!input||!box) return;
      const q=input.value.trim().toLowerCase();
      box.innerHTML='';
      if(!q){ buildRoomsForFloor(currentFloor); return; }
      Object.values(ROOM_INFO).forEach(rooms=>{
        Object.entries(rooms).forEach(([code,label])=>{
          if(code.toLowerCase().includes(q) || (label&&label.toLowerCase().includes(q))) addRoomCard(code,label);
        });
      });
    }
    function clearSearch(){ const i=$('#searchInput'); if(i){ i.value=''; filterRooms(); } }

    function openConfirm(code,label){
      pendingTarget={code,label};
      const msg=$('#confirmMsg'); if(msg) msg.textContent=code+'호 '+(label||'')+' 로 안내할까요?';
      $('#confirmWrap')?.classList.add('show');
    }
    function closeConfirm(){ $('#confirmWrap')?.classList.remove('show'); pendingTarget=null; }

    async function api(path, method="GET", body=null){
      const url = BACKEND_URL.replace(/\/+$/,'') + path;
      const opt={ method, headers: { 'x-api-key': API_KEY } };
      if(body){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
      const r=await fetch(url, opt);
      if(!r.ok) throw new Error(method+" "+path+" failed: "+r.status);
      const ct=r.headers.get('content-type')||'';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    async function confirmNavigate(){
      if(!pendingTarget) return;
      const yes=$('#confirmYes'), no=$('#confirmNo');
      [yes,no].forEach(b=>b && (b.disabled=true));

      const target=pendingTarget; closeConfirm();

      try{
        await api('/api/navigate','POST',{ room: Number(target.code) });
      }catch(e){
        alert('안내 시작 실패: 서버 연결 또는 좌표 설정을 확인하세요.');
        console.error(e);
        [yes,no].forEach(b=>b && (b.disabled=false));
        return;
      }finally{
        [yes,no].forEach(b=>b && (b.disabled=false));
      }

      activeRoom=target.code;
      activeLabel=target.label || null;
      guiding=true; paused=false; summoning=false; rendezvous=false; resumeTarget=null; rendezvousRoom=null;
      const g=$('#goalText'); if(g) g.textContent=target.code+'호'+(activeLabel?(' ('+activeLabel+')'):'');
      const s=$('#guideStatus'); if(s) s.textContent='안내 시작됨';
      const pb=$('#pauseBtn'); if(pb) pb.textContent='정지';
      showPage('page-guide');
      startPolling();
    }

    async function togglePause(){
      if(!guiding) return;
      const pb=$('#pauseBtn'), sb=$('#stopBtn'), lb=$('#lostBtn');
      [pb,sb,lb].forEach(b=>b && (b.disabled=true));
      try{
        if(!paused){
          await api('/api/stop','POST');
          paused=true; if(pb) pb.textContent='안내 재개';
          const s=$('#guideStatus'); if(s) s.textContent='일시 정지됨';
        } else {
          await api('/api/resume','POST');
          paused=false; if(pb) pb.textContent='정지';
          const s=$('#guideStatus'); if(s) s.textContent='안내중';
        }
      }catch(e){
        alert('동작 실패: 연결 상태를 확인하세요.');
        console.error(e);
      }finally{
        [pb,sb,lb].forEach(b=>b && (b.disabled=false));
      }
    }
    async function stopGuide(){
      const pb=$('#pauseBtn'), sb=$('#stopBtn'), lb=$('#lostBtn');
      [pb,sb,lb].forEach(b=>b && (b.disabled=true));
      try{ await api('/api/stop','POST'); }catch(e){ console.warn(e); }
      guiding=false; paused=false; activeRoom=null; activeLabel=null; rendezvous=false; resumeTarget=null; rendezvousRoom=null;
      stopPolling(); stopMock(); showPage('page-floor');
      [pb,sb,lb].forEach(b=>b && (b.disabled=false));
    }

    function startPolling(){
      stopPolling();
      ensureMap().finally(()=>{
        pollingTimer=window.setInterval(fetchStatus,1000);
        fetchStatus();
      });
    }
    function stopPolling(){ if(pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; } }

    async function fetchStatus(){
      try{
        const status=await api('/api/status','GET');
        lastStatus=status;

        // 소환/재합류 진행 중이면 상태 표시 업데이트
        if(summoning || rendezvous){
          const t=$('#summonStatus');
          if(t){
            if(status?.current) t.textContent = '현재 위치: '+fmtXY(status.current);
            else t.textContent = '연결 대기중…';
          }
        }

        // 안내중 UI 갱신
        if(guiding) updateGuideUI(status);

        // 도착 처리
        if(status && status.arrived){
          stopPolling();
          if(summoning){
            // 소환 완료 → 목적지 선택 화면
            summoning=false;
            openFloor(1);
            showPage('page-floor');
          }else if(rendezvous){
            // 재합류 완료 → 원래 목적지 재안내 여부 묻기
            openRejoinModal();
          }else if(guiding){
            // 일반 안내 도착 → 도착 모달
            openArrivedModal();
          }
        }
      }catch(e){
        if(summoning || rendezvous){
          const t=$('#summonStatus'); if(t) t.textContent='연결 대기중…';
        }else{
          const s=$('#guideStatus'); if(s) s.textContent='연결 대기중…';
        }
      }
    }

    /* ===== 도착 모달(UI 유지) ===== */
    function openArrivedModal(){
      const destText = activeRoom ? `${activeRoom}호${activeLabel ? ` (${activeLabel})` : ''}` : '목적지';
      const wrap = document.getElementById('arrivedWrap');
      const dest = document.getElementById('arrivedDest');
      if (wrap && dest) {
        dest.textContent = destText;
        wrap.classList.add('show');
      }
    }
    async function handleArrivedReturn(){
      try{
        await fetch(BACKEND_URL.replace(/\/+$/,'') + '/api/return', {
          method: 'POST',
          headers: { 'x-api-key': API_KEY }
        });
      }catch(e){ console.warn(e); }
      // 복귀 누르면 홈으로
      goHome();
      document.getElementById('arrivedWrap')?.classList.remove('show');
    }
    function closeArrivedModal(){
      document.getElementById('arrivedWrap')?.classList.remove('show');
    }

    /***** 지도 렌더링 *****/
    const mapEl=(function(){
      const c=document.getElementById('mapCanvas');
      if(!c) return null;
      function resize(){
        const rect=c.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        c.width=Math.max(1, Math.floor(rect.width*dpr));
        c.height=Math.max(1, Math.floor(rect.height*dpr));
      }
      const ro=new ResizeObserver(()=>{ resize(); drawMap(lastStatus); });
      ro.observe(c); resize(); return c;
    })();

    let _mapImg=null, _mapMeta=null, _screenFit=null;
    async function ensureMap(){
      if(_mapImg && _mapMeta) return;
      try{
        _mapMeta = await api('/api/map/meta','GET');
        const url = BACKEND_URL.replace(/\/+$/,'') + '/api/map.png';
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
        _mapImg = img;
      }catch(e){ console.warn('map load failed', e); }
    }

    function computeScreenFit(W,H,iw,ih){
      const s=Math.min(W/iw, H/ih);
      const dx=(W - iw*s)/2, dy=(H - ih*s)/2;
      return {s,dx,dy};
    }
    function worldToScreen(pt){
      if(!_mapMeta || !_screenFit) return null;
      const [x,y]=pt;
      const res=_mapMeta.resolution;
      const ox=_mapMeta.origin[0], oy=_mapMeta.origin[1];
      const iw=_mapMeta.width, ih=_mapMeta.height;
      let px=(x - ox)/res;
      let py=(y - oy)/res;
      py = (ih - 1) - py;
      const {s,dx,dy}=_screenFit;
      const X = dx + px*s;
      const Y = dy + py*s;
      return [X,Y];
    }

    function updateGuideUI(status){
      if(status?.current){ const t=$('#curPosText'); if(t) t.textContent = fmtXY(status.current); }
      if(activeRoom){ const g=$('#goalText'); if(g) g.textContent = activeRoom+'호'+(activeLabel?(' ('+activeLabel+')'):''); }
      const s=$('#guideStatus'); if(s) s.textContent = paused ? '일시 정지됨' : '안내중';
      drawMap(status);
    }

    function drawMap(status){
      if(!mapEl) return;
      const c=mapEl, ctx=c.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      ctx.save(); ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,c.width, c.height);
      const W=c.width/dpr, H=c.height/dpr;

      if(_mapImg && _mapMeta){
        _screenFit = computeScreenFit(W,H,_mapImg.width,_mapImg.height);
        const {s,dx,dy}=_screenFit;
        ctx.drawImage(_mapImg, dx, dy, _mapImg.width*s, _mapImg.height*s);
      }else{
        ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,W,H);
      }

      if(!status || (!status.path && !status.current && !status.goal)){
        ctx.fillStyle='#9ca3af'; ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.textAlign='center';
        ctx.fillText('연결 대기중… (경로/좌표 수신 시 자동 표시)', W/2, H/2);
        ctx.restore(); return;
      }

      if(Array.isArray(status.path) && status.path.length>=2){
        ctx.lineWidth=3; ctx.strokeStyle='#22c55e';
        ctx.beginPath();
        status.path.forEach(function(p,i){
          const P = worldToScreen(p) || relToScreen(p);
          if(!P) return;
          if(i===0) ctx.moveTo(P[0],P[1]); else ctx.lineTo(P[0],P[1]);
        });
        ctx.stroke();
      }

      if(Array.isArray(status.goal)){
        const G = worldToScreen(status.goal) || relToScreen(status.goal);
        if(G){ ctx.fillStyle='#2563eb'; ctx.beginPath(); ctx.arc(G[0],G[1],6,0,Math.PI*2); ctx.fill(); }
      }

      if(Array.isArray(status.current)){
        const C = worldToScreen(status.current) || relToScreen(status.current);
        if(C){ ctx.fillStyle='#111827'; ctx.beginPath(); ctx.arc(C[0],C[1],6,0,Math.PI*2); ctx.fill(); }
      }

      ctx.restore();

      function relToScreen(pt){
        if(!status) return null;
        const pts=[];
        if(Array.isArray(status.path)) status.path.forEach(p=>Array.isArray(p)&&p.length===2&&pts.push(p));
        if(Array.isArray(status.current)) pts.push(status.current);
        if(Array.isArray(status.goal)) pts.push(status.goal);
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        pts.forEach(function(v){ const x=v[0], y=v[1]; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
        if(!isFinite(minX)){ minX=0;minY=0;maxX=10;maxY=10; }
        const pad=24;
        const sx=(W-2*pad)/Math.max(1e-6,(maxX-minX));
        const sy=(H-2*pad)/Math.max(1e-6,(maxY-minY));
        const s=Math.min(sx,sy);
        const x=pt[0], y=pt[1];
        const X = pad + (x-minX)*s;
        const Y = H - pad - (y-minY)*s;
        return [X,Y];
      }
    }
    function fmtXY(p){ if(!Array.isArray(p)) return '-'; const x=Number(p[0]||0), y=Number(p[1]||0); return x.toFixed(2)+", "+y.toFixed(2); }

    let _mockTimer=null;
    function startMockRun(){}
    function stopMock(){ if(_mockTimer){ clearInterval(_mockTimer); _mockTimer=null; } }

    /***** 소환(복귀) 흐름 *****/
    async function startSummon(){
      try{
        await api('/api/return','POST');
      }catch(e){
        alert('로봇 소환 실패: 서버 연결 또는 복귀 좌표 설정을 확인하세요.');
        console.error(e);
        return;
      }
      summoning=true; guiding=false; paused=false; activeRoom=null; activeLabel=null;
      rendezvous=false; resumeTarget=null; rendezvousRoom=null;
      // 소환 화면 문구
      $('#summonPill').textContent='소환중';
      $('#summonTitle').textContent='로봇이 열심히 가고 있어요…';
      $('#summonHint').textContent='로봇이 도착하면 목적지를 선택할 수 있어요.';
      showPage('page-summon');
      startPolling();
    }

    /***** ▼ 신규: 재합류(로봇이 보이지 않을 때) 흐름 *****/
    async function startLostFlow(){
      // 1) 즉시 정지
      try{ await api('/api/stop','POST'); }catch(e){ console.warn(e); }
      paused=true; guiding=false; // 안내 잠시 중단
      // 2) 입력 모달 열기
      $('#lostInput').value='';
      $('#lostWrap')?.classList.add('show');
    }
    function closeLostModal(){ $('#lostWrap')?.classList.remove('show'); }

    async function confirmRendezvous(){
      const val = ($('#lostInput')?.value||'').trim();
      if(!/^\d+$/.test(val)){ alert('호실 번호를 숫자로 입력해 주세요. 예: 101'); return; }
      // 3) 원래 목적지 저장
      if(activeRoom){
        resumeTarget = { code: activeRoom, label: activeLabel || null };
      } else {
        resumeTarget = null;
      }
      rendezvousRoom = val;
      // 4) 해당 호실로 이동
      closeLostModal();
      try{
        await api('/api/navigate','POST',{ room: Number(val) });
      }catch(e){
        alert('이동 시작 실패: 서버 연결 또는 좌표 설정을 확인하세요.');
        console.error(e);
        return;
      }
      // 5) 재합류 대기 화면으로 전환
      summoning=false; rendezvous=true;
      $('#summonPill').textContent='재합류중';
      $('#summonTitle').textContent=`로봇이 ${val}호 앞으로 이동 중…`;
      $('#summonHint').textContent='로봇이 도착하면 원래 목적지로 재안내를 시작할 수 있어요.';
      showPage('page-summon');
      startPolling();
    }

    function openRejoinModal(){
      // 재합류 완료
      rendezvous=true; // 여전히 플래그 true 상태에서 모달 띄움
      const wrap = $('#rejoinWrap');
      $('#rejoinMsg').textContent = resumeTarget
        ? `원래 목적지(${resumeTarget.code}호${resumeTarget.label?` (${resumeTarget.label})`:''})로 안내를 다시 시작할까요?`
        : '원래 목적지가 없습니다. 목적지를 선택하시겠어요?';
      if(wrap){ wrap.classList.add('show'); }
    }
    function closeRejoinModal(){ $('#rejoinWrap')?.classList.remove('show'); }

    async function rejoinYes(){
      closeRejoinModal();
      if(resumeTarget && resumeTarget.code){
        try{
          await api('/api/navigate','POST',{ room: Number(resumeTarget.code) });
        }catch(e){
          alert('재안내 시작 실패: 서버 연결을 확인하세요.');
          console.error(e);
          return;
        }
        activeRoom = String(resumeTarget.code);
        activeLabel = resumeTarget.label || null;
        guiding=true; paused=false; rendezvous=false; summoning=false;
        $('#goalText').textContent = activeRoom+'호'+(activeLabel?(' ('+activeLabel+')'):'');
        $('#guideStatus').textContent = '안내 시작됨';
        showPage('page-guide');
        startPolling();
      } else {
        // 원래 목적지 없으면 목적지 선택 화면으로
        rendezvous=false; summoning=false; guiding=false; paused=false;
        openFloor(1); showPage('page-floor');
      }
    }
    function rejoinNo(){
      // 재안내 거절: 목적지 선택 화면으로 이동(명확)
      closeRejoinModal();
      rendezvous=false; summoning=false; guiding=false; paused=false;
      openFloor(1); showPage('page-floor');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      $('#homeBtn')?.addEventListener('click', goHome);
      $('#backBtn')?.addEventListener('click', goBack);

      // 홈 버튼: 함께/소환
      $('#btnTogether')?.addEventListener('click', startGuide);
      $('#btnSummon')?.addEventListener('click', startSummon);

      // 층 탭
      document.getElementById('tab-1')?.addEventListener('click', ()=>openFloor(1));
      document.getElementById('tab-2')?.addEventListener('click', ()=>openFloor(2));
      document.getElementById('tab-3')?.addEventListener('click', ()=>openFloor(3));

      // 검색
      $('#searchInput')?.addEventListener('input', filterRooms);
      $('#clearSearchBtn')?.addEventListener('click', clearSearch);

      // 안내 제어
      $('#pauseBtn')?.addEventListener('click', togglePause);
      $('#stopBtn')?.addEventListener('click', stopGuide);
      // 신규: 로봇이 보이지 않아요
      $('#lostBtn')?.addEventListener('click', startLostFlow);

      // 확인 모달
      $('#confirmNo')?.addEventListener('click', closeConfirm);
      $('#confirmYes')?.addEventListener('click', confirmNavigate);

      // 도착 모달
      document.getElementById('arrivedReturn')?.addEventListener('click', handleArrivedReturn);
      document.getElementById('arrivedClose')?.addEventListener('click', closeArrivedModal);

      // 신규: Lost 입력 모달
      $('#lostClear')?.addEventListener('click', ()=>{ const i=$('#lostInput'); if(i) i.value=''; i?.focus(); });
      $('#lostCancel')?.addEventListener('click', closeLostModal);
      $('#lostGo')?.addEventListener('click', confirmRendezvous);
      $('#lostInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') confirmRendezvous(); });

      // 신규: 재안내 모달
      $('#rejoinYes')?.addEventListener('click', rejoinYes);
      $('#rejoinNo')?.addEventListener('click', rejoinNo);

      // 초기 상태
      document.body.classList.add('home-active');
      showPage('page-home');
    });
  </script>
</body>
</html>
    


